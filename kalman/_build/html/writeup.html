

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>1. Writeup &#8212; SDEs Project - The Kalman Filter</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'writeup';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3. Bibliography" href="bibliography.html" />
    <link rel="prev" title="The Kalman Filter" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    <p class="title logo__title">SDEs Project - The Kalman Filter</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Kalman Filter
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">1. Writeup</a></li>

<li class="toctree-l1"><a class="reference internal" href="bibliography.html">3. Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_appendix.html">4. Appendix of additional (secondary) code.</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/domoench/kalman" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/writeup.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Writeup</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">1. Writeup</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-1d-kalman-filter">1.1. The 1D Kalman Filter</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">1.1.1. Implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#demonstration-on-temperature-data">1.1.2. Demonstration on temperature data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-linear-kalman-filter-applied-to-non-linear-data">1.1.3. A linear kalman filter applied to non-linear data?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#behavior-in-the-presence-of-data-gaps">1.1.4. Behavior in the presence of data gaps</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-multivariate-kalman-filter">1.2. The Multivariate Kalman Filter</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-and-synthesis-of-input-data">1.2.1. Implementation and synthesis of input data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#accuracy-metrics">1.2.2. Accuracy Metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#normalized-estimated-error-squared-nees">1.2.2.1. Normalized Estimated Error Squared (NEES)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sigma-membership-accuracy-score">1.2.2.2. <span class="math notranslate nohighlight">\(3 \sigma\)</span> Membership Accuracy Score</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performance">1.2.3. Performance</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-state-estimate-perturbation">1.2.3.1. Initial state estimate perturbation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#q-r-perturbation-from-their-true-values">1.2.3.2. <span class="math notranslate nohighlight">\(Q\)</span>,<span class="math notranslate nohighlight">\(R\)</span> perturbation from their true values.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">1.3. Conclusion</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#code">2. Code</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#global-temp-anomaly-data">2.1. Global Temp Anomaly Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">2.2. The 1D Kalman Filter</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-kalman-implementation">2.2.1. Implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-how-the-kalman-filter-behaves-with-data-gaps">2.2.2. Exploring how the kalman filter behaves with data gaps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-parameter-space-of-q-x-r">2.2.3. Exploring the parameter space of <span class="math notranslate nohighlight">\(Q\)</span> x <span class="math notranslate nohighlight">\(R\)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-bayesian-intuition-underlying-the-kalman-filter">2.3. The Bayesian Intuition underlying the Kalman Filter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multidimensional-kalman-filter-for-a-process-with-constant-acceleration">2.4. Multidimensional Kalman Filter (for a Process With Constant Acceleration)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthesizing-true-state-vec-x-k">2.4.1. Synthesizing true state <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthesizing-measurements">2.4.2. Synthesizing measurements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multidimensional-filter-implementation">2.4.3. Multidimensional Filter Implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#demonstration-on-synthetic-data">2.4.4. Demonstration on synthetic data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-covariance-of-position-with-velocity">2.4.5. Exploring covariance of position with velocity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-the-accuracy-of-the-kalman-filter-s-predictions">2.4.6. Quantifying the Accuracy of the Kalman Filter’s Predictions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nees-normalized-estimated-error-squared">2.4.6.1. NEES (Normalized Estimated Error Squared)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sigma-membership-accuracy-score-do-the-true-positions-vec-x-k-fall-within-the-hat-x-k-estimates-3-sigma-confidence-ellipses">2.4.6.2. <span class="math notranslate nohighlight">\(3\sigma\)</span> Membership Accuracy Score: Do the true positions <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> fall within the <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> estimates’ <span class="math notranslate nohighlight">\(3\sigma\)</span> confidence ellipses?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-residuals">2.4.6.3. Exploring Residuals</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-3-sigma-membership-accuracy-score-as-a-function-of-initial-state-guess-perturbation">2.4.7. Visualizing the <span class="math notranslate nohighlight">\(3 \sigma\)</span> membership accuracy score as a function of initial state guess perturbation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-q-r-parameter-space-for-the-multivariable-kalman-filter-example">2.4.8. Exploring <span class="math notranslate nohighlight">\(Q\)</span>,<span class="math notranslate nohighlight">\(R\)</span> parameter space for the multivariable Kalman filter example</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="writeup">
<span id="id1"></span><h1><span class="section-number">1. </span>Writeup<a class="headerlink" href="#writeup" title="Permalink to this heading">#</a></h1>
<p>I summarize my explorations and findings in this Writeup section.</p>
<section id="the-1d-kalman-filter">
<h2><span class="section-number">1.1. </span>The 1D Kalman Filter<a class="headerlink" href="#the-1d-kalman-filter" title="Permalink to this heading">#</a></h2>
<p>Here we implement the 1D Kalman filter and apply it to a simple problem involving global temperature data.</p>
<section id="implementation">
<h3><span class="section-number">1.1.1. </span>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">#</a></h3>
<p>As in <span id="id2">[<a class="reference internal" href="bibliography.html#id3" title="Peter C Young. Recursive estimation and time-series analysis: An introduction for the student and practitioner. Springer Science &amp; Business Media, 2011.">You11</a>]</span> (Chapter 4.4, moving body example) we implement the linear Kalman filter to estimate a single state variable over time.</p>
<p>The code for that implementation is in <a class="reference internal" href="#d-kalman-implementation"><span class="std std-numref">Section 2.2.1</span></a>.</p>
</section>
<section id="demonstration-on-temperature-data">
<h3><span class="section-number">1.1.2. </span>Demonstration on temperature data<a class="headerlink" href="#demonstration-on-temperature-data" title="Permalink to this heading">#</a></h3>
<p>As Young points out, there is a relationship between the filtering problem and regression. We can transform a regression problem into the filtering problem, then apply the Kalman Filter.</p>
<p>To demonstrate this, take the following data set from NASA <span id="id3">[<a class="reference internal" href="bibliography.html#id5" title="Global land-ocean temperature index. https://data.giss.nasa.gov/gistemp/graphs/graph_data/Global_Mean_Estimates_based_on_Land_and_Ocean_Data/graph.txt. Accessed: 2023-08-10.">nas</a>]</span>, which depicts the annual global average temperature as compared to a baseline temperature (the average temperature over the period of 1951 to 1980):</p>
<figure class="align-default" id="global-temp-fig" style="width: 600px">
<img alt="_images/89866adc6a92c7995baa21ff7ab1816ce80660f07b4fd51377413ed3b6b47b8e.png" src="_images/89866adc6a92c7995baa21ff7ab1816ce80660f07b4fd51377413ed3b6b47b8e.png" />
</figure>
<p>There is clearly an upward trend, but the data is noisy - from one year to the next the annual temperature average may go up or down. Furthermore, the upward trend appears nonlinear. How can we determine the trend from the noise?</p>
<p>We may transform this into filtering problem in a few ways:</p>
<ol class="arabic simple">
<li><p>Imagine the temperature is a noisy process and we have perfect measurements.</p></li>
<li><p>Imagine the temperature is fully deterministic process and we have noisy measurements.</p></li>
<li><p>Imagine the both the temperature process and our measurements have noise.</p></li>
</ol>
<p>Then our Kalman filter estimate will be a regression of this temperature data.</p>
<p>Let’s go with option 3. If we design our process to assume a constant temperature (<span class="math notranslate nohighlight">\(x(k) = x(k-1) + \eta(k)\)</span>), then choose measurement noise variance <span class="math notranslate nohighlight">\(R\)</span> = <span class="output text_plain">0.5</span> and process noise <span class="math notranslate nohighlight">\(Q\)</span> = <span class="output text_plain">0.05</span>, we get the following filter output:</p>
<figure class="align-default" id="global-temp-kalman-1d" style="width: 650px">
<img alt="_images/7e198e5e81aaaaee47b0f630fdd0ca2fd24ef4c5de78e82bdcc6332c1998ed42.png" src="_images/7e198e5e81aaaaee47b0f630fdd0ca2fd24ef4c5de78e82bdcc6332c1998ed42.png" />
<figcaption>
<p><span class="caption-number">Fig. 1.1 </span><span class="caption-text">The kalman-estimated temperature trend approximates the lowess regression of the noisy temperature data. Code in <a class="reference internal" href="#d-kalman-implementation"><span class="std std-numref">Section 2.2.1</span></a>.</span><a class="headerlink" href="#global-temp-kalman-1d" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="a-linear-kalman-filter-applied-to-non-linear-data">
<h3><span class="section-number">1.1.3. </span>A linear kalman filter applied to non-linear data?<a class="headerlink" href="#a-linear-kalman-filter-applied-to-non-linear-data" title="Permalink to this heading">#</a></h3>
<p>Why was our linear-process-model Kalman Filter able to produce a non-linear regression? Even though we defined a constant temperature process, it is still a <em>stochastic</em> process with some non-zero noise  <span class="math notranslate nohighlight">\(\vec{\eta}(k) \sim \mathcal{N}(0, Q)\)</span>. That uncertainty in the process-based predictions allows the measurements to pull the estimates upwards during the update steps.</p>
<p>The way we tune <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(R\)</span> impacts this behavior. The two other extremes of parameter tuning (options 1 and 2 listed above) produce the following filter outputs:</p>
<figure class="align-default" id="kt-lqhr-fig" style="width: 500px">
<img alt="_images/fd918a6970adbbb7260efca3e2a233c65e6fc6fba86ffcdc1617176338d2bb51.png" src="_images/fd918a6970adbbb7260efca3e2a233c65e6fc6fba86ffcdc1617176338d2bb51.png" />
<figcaption>
<p><span class="caption-number">Fig. 1.2 </span><span class="caption-text">Low Q, High R</span><a class="headerlink" href="#kt-lqhr-fig" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<figure class="align-default" id="kt-hqlr-fig" style="width: 500px">
<img alt="_images/e9c8ebf180016ddb05ec2548dd46f026a4cc15b0c193c691852efa9a4cfffde7.png" src="_images/e9c8ebf180016ddb05ec2548dd46f026a4cc15b0c193c691852efa9a4cfffde7.png" />
<figcaption>
<p><span class="caption-number">Fig. 1.3 </span><span class="caption-text">High Q, Low R</span><a class="headerlink" href="#kt-hqlr-fig" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p><a class="reference internal" href="#kt-lqhr-fig"><span class="std std-numref">Fig. 1.2</span></a> Shows Low Q and High R (<span class="math notranslate nohighlight">\(Q\)</span> = <span class="output text_plain">0.0</span>, <span class="math notranslate nohighlight">\(R\)</span> = <span class="output text_plain">3.0</span>). The result is an estimate that lags behind the upward trend of the measurements, because the constant-temp process model’s predictions are weighted more heavily than the measurements.</p>
<p><a class="reference internal" href="#kt-hqlr-fig"><span class="std std-numref">Fig. 1.3</span></a> Shows High Q and Low R (<span class="math notranslate nohighlight">\(Q\)</span> = <span class="output text_plain">3.0</span>, <span class="math notranslate nohighlight">\(R\)</span> = <span class="output text_plain">0.0</span>). The result is a jagged estimate that hugs the data points tightly because our filter assumes no measurement noise.</p>
<p>The code that generated both the above figures is in <a class="reference internal" href="#exploring-param-space-1d"><span class="std std-numref">Section 2.2.3</span></a>.</p>
</section>
<section id="behavior-in-the-presence-of-data-gaps">
<h3><span class="section-number">1.1.4. </span>Behavior in the presence of data gaps<a class="headerlink" href="#behavior-in-the-presence-of-data-gaps" title="Permalink to this heading">#</a></h3>
<p>My implementation replicates Young’s illustration of how the filter estimate’s variance <span class="math notranslate nohighlight">\(P\)</span> grows over a period of missing data.</p>
<figure class="align-default" id="kt-data-gap" style="width: 500px">
<img alt="_images/80d8f1c5c1da42b3c26bdd850998d80b8b25deb1ffb5b6fcaf1006011fdad060.png" src="_images/80d8f1c5c1da42b3c26bdd850998d80b8b25deb1ffb5b6fcaf1006011fdad060.png" />
<figcaption>
<p><span class="caption-number">Fig. 1.4 </span><span class="caption-text">The <span class="math notranslate nohighlight">\(1 \sigma\)</span> error bounds depicting <span class="math notranslate nohighlight">\(P(k)\)</span> grows over a period of missing measurement data, before contracting quickly once new data points come in. Code in <a class="reference internal" href="#id8"><span class="std std-numref">Section 2.2.2</span></a>.</span><a class="headerlink" href="#kt-data-gap" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="the-multivariate-kalman-filter">
<h2><span class="section-number">1.2. </span>The Multivariate Kalman Filter<a class="headerlink" href="#the-multivariate-kalman-filter" title="Permalink to this heading">#</a></h2>
<section id="implementation-and-synthesis-of-input-data">
<h3><span class="section-number">1.2.1. </span>Implementation and synthesis of input data<a class="headerlink" href="#implementation-and-synthesis-of-input-data" title="Permalink to this heading">#</a></h3>
<p>I implemented a multivariate Kalman Filter (<a class="reference internal" href="#multivar-kf-implementation"><span class="std std-numref">Section 2.4.3</span></a>) and synthesized a true 6-dimensional data series <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> for a moving object under constant acceleration and its measurements <span class="math notranslate nohighlight">\(\vec{z}(k)\)</span> (<a class="reference internal" href="#synth-true-state"><span class="std std-numref">Section 2.4.1</span></a>).</p>
<figure class="align-default" id="mv-kf-pos" style="width: 650px">
<img alt="_images/9403d6286f10c1e30d26f1dc117c2da815d1c9cf99e64824123f0094f6378427.png" src="_images/9403d6286f10c1e30d26f1dc117c2da815d1c9cf99e64824123f0094f6378427.png" />
<figcaption>
<p><span class="caption-number">Fig. 1.5 </span><span class="caption-text">The filter produces a position estimate that is convincingly close to the true state’s postition.</span><a class="headerlink" href="#mv-kf-pos" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>If we pull out the position, velocity, and acceleration estimates and covariance matrices from <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> and <span class="math notranslate nohighlight">\(P(k)\)</span> we can visualize them separately (<a class="reference internal" href="#multivar-kf-demo"><span class="std std-numref">Section 2.4.4</span></a>):</p>
<figure class="align-default" id="mv-kf-pos-vel-acc" style="width: 750px">
<img alt="_images/8ecd51ce0633a55e0d4ef7392c7bd1f52cd15c4a5114bb77ed618599dc0557de.png" src="_images/8ecd51ce0633a55e0d4ef7392c7bd1f52cd15c4a5114bb77ed618599dc0557de.png" />
</figure>
<figure class="align-default" id="mv-kf-pva-variances" style="width: 750px">
<img alt="_images/ad77c6161464b27f6e8fea427d23472286a5e23881be280f569233402f3f0da2.png" src="_images/ad77c6161464b27f6e8fea427d23472286a5e23881be280f569233402f3f0da2.png" />
<figcaption>
<p><span class="caption-number">Fig. 1.6 </span><span class="caption-text">Estimates and their respective variances over time.</span><a class="headerlink" href="#mv-kf-pva-variances" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>We see the position estimate quickly converges close to the true position, and similarly the position estimate’s variance
<span class="math notranslate nohighlight">\(\begin{bmatrix}
\sigma_{x} &amp; 0 \\
0 &amp; \sigma_{y}
\end{bmatrix}\)</span>
rapidly reduces in magnitude. <a class="reference internal" href="#mv-kf-pva-variances"><span class="std std-numref">Fig. 1.6</span></a> shows the steep reduction in <span class="math notranslate nohighlight">\(\sigma_{x}\)</span> and <span class="math notranslate nohighlight">\(\sigma_{y}\)</span>, and that a similar convergence plays out for the velocity estimates/variance at a slower rate, and for acceleration at a slower rate still.</p>
</section>
<section id="accuracy-metrics">
<span id="id4"></span><h3><span class="section-number">1.2.2. </span>Accuracy Metrics<a class="headerlink" href="#accuracy-metrics" title="Permalink to this heading">#</a></h3>
<p>I primarily explore 2 methods of quantifying accuracy:</p>
<ol class="arabic simple">
<li><p>Normalized Estimated Error Squared (NEES).</p></li>
<li><p><span class="math notranslate nohighlight">\(3 \sigma\)</span> Membership Accuracy Score: The ratio of estimates <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> whose <span class="math notranslate nohighlight">\(3 \sigma\)</span> covariance ellipses of <span class="math notranslate nohighlight">\(P(k)\)</span> contain the true state <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span>.</p></li>
</ol>
<section id="normalized-estimated-error-squared-nees">
<h4><span class="section-number">1.2.2.1. </span>Normalized Estimated Error Squared (NEES)<a class="headerlink" href="#normalized-estimated-error-squared-nees" title="Permalink to this heading">#</a></h4>
<p>NEES is a standard way of evaluating the accuracy of the Kalman filter when the true state series <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> is known (as is the case here). Details of my implementation and exploration are in <a class="reference internal" href="#nees-implementation"><span class="std std-numref">Section 2.4.6.1</span></a>.</p>
</section>
<section id="sigma-membership-accuracy-score">
<h4><span class="section-number">1.2.2.2. </span><span class="math notranslate nohighlight">\(3 \sigma\)</span> Membership Accuracy Score<a class="headerlink" href="#sigma-membership-accuracy-score" title="Permalink to this heading">#</a></h4>
<p>I implemented an intuitive and simple way of quantifying the accuracy of the Kalman filter’s estimates.</p>
<p>The score works as follows. For each estimate <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span>, check if the associated true state point <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> falls within the <span class="math notranslate nohighlight">\(3\sigma\)</span> covariance ellipse for <span class="math notranslate nohighlight">\(P(k)\)</span>. Then simply compute the ratio of estimates for which <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> is a member of <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span>’s ellipse out of all estimates. Implementation in <a class="reference internal" href="#sig-membership-implementation"><span class="std std-numref">Section 2.4.6.2</span></a>.</p>
<p>Here’s a visualized example, where the Kalman filter’s <span class="math notranslate nohighlight">\(3\sigma\)</span> membership accuracy score is <span class="output text_plain">0.8</span>:</p>
<figure class="align-default" id="sig-membership-viz" style="width: 650px">
<img alt="_images/9d7cb9f84f850c68cab32d92e82155c0eda567929d7486c6de02796ea449ab2e.png" src="_images/9d7cb9f84f850c68cab32d92e82155c0eda567929d7486c6de02796ea449ab2e.png" />
<figcaption>
<p><span class="caption-number">Fig. 1.7 </span><span class="caption-text">Each (<span class="math notranslate nohighlight">\(\hat{x}(k)\)</span>, <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span>) pair is connected by a line segment, which is colored green if <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> is a member of <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span>’s <span class="math notranslate nohighlight">\(3\sigma\)</span> ellipse and red otherwise.</span><a class="headerlink" href="#sig-membership-viz" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p><em>Note: This score only useful for relative comparisons between filter runs on the same data set, which is primarily what I’m doing here. Furthermore, the scalar nature of the score loses information about the filter performance, such as the relative speed at which the residual magnitudes <span class="math notranslate nohighlight">\(|\vec{x}(k)-\hat{x}(k)|\)</span> converge.</em></p>
</section>
</section>
<section id="performance">
<h3><span class="section-number">1.2.3. </span>Performance<a class="headerlink" href="#performance" title="Permalink to this heading">#</a></h3>
<p>Our filter’s behavior is dependent on our choice of a few parameters, including an initial state estimate <span class="math notranslate nohighlight">\(\hat{x}(0)\)</span>, initial estimate covariance <span class="math notranslate nohighlight">\(P(0)\)</span>, and covariances <span class="math notranslate nohighlight">\(R\)</span>, and <span class="math notranslate nohighlight">\(Q\)</span>. How sensitive is the filter’s accuracy to the perturbations to those parameters?</p>
<section id="initial-state-estimate-perturbation">
<h4><span class="section-number">1.2.3.1. </span>Initial state estimate perturbation<a class="headerlink" href="#initial-state-estimate-perturbation" title="Permalink to this heading">#</a></h4>
<p>I used Monte Carlo methods to explore the relationship between initial state estimate perturbations and the filter accuracy distribution. As perturbations to the initial state guess <span class="math notranslate nohighlight">\(\hat{x}(0)\)</span> increase, the sample mean of both accuracy metrics decreases and variance increases:</p>
<figure class="align-default" id="sm-v-perturbation" style="width: 550px">
<img alt="_images/547a3e1708760691f77e5038c7dbe2e7696d631b26ba3c3ff1e3a4ecff1590aa.png" src="_images/547a3e1708760691f77e5038c7dbe2e7696d631b26ba3c3ff1e3a4ecff1590aa.png" />
</figure>
<figure class="align-default" id="nees-v-perturbation" style="width: 550px">
<img alt="_images/8b0eb493465fce5c1089d8a3d1ad0d622895ebbf2bd9d0303edc38f3d1c0061e.png" src="_images/8b0eb493465fce5c1089d8a3d1ad0d622895ebbf2bd9d0303edc38f3d1c0061e.png" />
<figcaption>
<p><span class="caption-number">Fig. 1.8 </span><span class="caption-text">Increasing average NEES scores means lower overall estimate accuracy.</span><a class="headerlink" href="#nees-v-perturbation" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>The code that produced both figures above is in <a class="reference internal" href="#init-state-pertub"><span class="std std-numref">Section 2.4.7</span></a>. Random perturbation vectors were generated on <span class="math notranslate nohighlight">\((d-1)\)</span>-balls of increasing radii via the Muller method <a class="reference internal" href="code_appendix.html#muller-algo"><span class="std std-numref">Section 4.4</span></a>).</p>
</section>
<section id="q-r-perturbation-from-their-true-values">
<h4><span class="section-number">1.2.3.2. </span><span class="math notranslate nohighlight">\(Q\)</span>,<span class="math notranslate nohighlight">\(R\)</span> perturbation from their true values.<a class="headerlink" href="#q-r-perturbation-from-their-true-values" title="Permalink to this heading">#</a></h4>
<p>What if we didn’t know the true values of <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(R\)</span> and needed to approximate or guess their values? How does the filter’s accuracy change as a function of a perturbations of <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(R\)</span> from their true values?</p>
<p>In <a class="reference internal" href="#qr-param-space"><span class="std std-numref">Section 2.4.8</span></a> I numerically explore a sub-section of the (<span class="math notranslate nohighlight">\(Q\)</span>,<span class="math notranslate nohighlight">\(R\)</span>) parameter space and produce accuracy surfaces (for <a class="reference internal" href="#accuracy-metrics"><span class="std std-ref">both metrics</span></a>):</p>
<figure class="align-default" id="acc-surface-fig" style="width: 700px">
<img alt="_images/f8cb365c35ffd59c4d68b63043a7fa36fd5e4bea39b20bc6c025f635c1539e19.png" src="_images/f8cb365c35ffd59c4d68b63043a7fa36fd5e4bea39b20bc6c025f635c1539e19.png" />
</figure>
<p>The result is that in scaling process noise <span class="math notranslate nohighlight">\(Q\)</span> has little impact on the filter’s estimation accuracy with our data set, while scaling measurement noise <span class="math notranslate nohighlight">\(R\)</span> has relatively high impact. As we increase R’s values from <span class="math notranslate nohighlight">\(0\)</span> to <span class="math notranslate nohighlight">\(0.6\)</span> of <span class="math notranslate nohighlight">\(R*\)</span> (the true measurement noise) we get a rapid increase in accuracy, which then converges asymptotically to a stable high accuracy value for larger scaling factors.</p>
</section>
</section>
</section>
<section id="conclusion">
<h2><span class="section-number">1.3. </span>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this heading">#</a></h2>
<p>I have implemented the univariate and multivariate Kalman Filter, implemented 2 methods to evaluate its accuracy, and conducted a number of numerical explorations including applying the filter to perform regression on global temperature data and evaluating the accuracy of the multivariate filter’s estimates on a synthetic data set in response to perturbing filter parameters.</p>
<p>The lower-level details of my explorations, including a number of explorations I did not feel warranted inclusion in the write up, may be found in the <a class="reference internal" href="#code"><span class="std std-ref">Code section</span></a> below and in the <a class="reference internal" href="code_appendix.html#secondary-code-appendix"><span class="std std-ref">Secondary Code Appendix</span></a>.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="code">
<span id="id5"></span><h1><span class="section-number">2. </span>Code<a class="headerlink" href="#code" title="Permalink to this heading">#</a></h1>
<p>Below are the details of my analysis, including code implementation and low-level explanations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">collections</span> <span class="k">as</span> <span class="n">mc</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">from</span> <span class="nn">myst_nb</span> <span class="kn">import</span> <span class="n">glue</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="n">reload</span><span class="p">(</span><span class="n">utils</span><span class="p">)</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">IPython.core.debugger</span> <span class="kn">import</span> <span class="n">set_trace</span>
</pre></div>
</div>
</div>
</div>
<section id="global-temp-anomaly-data">
<h2><span class="section-number">2.1. </span>Global Temp Anomaly Data<a class="headerlink" href="#global-temp-anomaly-data" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;temp_anomalies.csv&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">no_smoothing</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Change from baseline temp.&#39;</span><span class="p">)</span>
<span class="c1">#plt.show()</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;global_temp_data&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/89866adc6a92c7995baa21ff7ab1816ce80660f07b4fd51377413ed3b6b47b8e.png" src="_images/89866adc6a92c7995baa21ff7ab1816ce80660f07b4fd51377413ed3b6b47b8e.png" />
</div>
</div>
</section>
<section id="id6">
<h2><span class="section-number">2.2. </span>The 1D Kalman Filter<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h2>
<section id="d-kalman-implementation">
<span id="id7"></span><h3><span class="section-number">2.2.1. </span>Implementation<a class="headerlink" href="#d-kalman-implementation" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the kalman filter algorithm on a series of observations and return</span>
<span class="c1"># the estimated state series</span>
<span class="k">def</span> <span class="nf">kalman_1d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">P_0</span><span class="p">,</span> <span class="n">x_0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        zs: Measurement series. An Nx1 array.</span>
<span class="sd">        R: Measurement noise variance.</span>
<span class="sd">        Q: Process noise variance</span>
<span class="sd">        P: Prior (prediction) variance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize system and filter state</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">Ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
    <span class="c1"># Prior</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P_0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_0</span>

    <span class="c1"># TODO: Should we exclude prediction calculation for first iteration?</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)):</span>
        <span class="c1"># PREDICT STEP - Process model update</span>
        <span class="c1"># dx = Gauss(0, Q)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">0</span> <span class="c1"># Prediction mean</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">+</span> <span class="n">Q</span> <span class="c1"># Prediction var</span>

        <span class="c1"># UPDATE STEP (if there is a measurement at this timestep)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zs</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span>

            <span class="c1"># Kalman Gain</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">P</span> <span class="o">/</span> <span class="p">(</span><span class="n">P</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span>

            <span class="c1"># Posterior: Use kalman gain to scale the residual between prediction and measurement</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">resid</span>
            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">K</span><span class="p">)</span> <span class="o">*</span> <span class="n">P</span>

        <span class="c1"># Save results</span>
        <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">Ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
        
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span>

<span class="c1"># Configure and run the filter</span>
<span class="n">R</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Measurement variance</span>
<span class="n">Q</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c1"># Process noise variance</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;kalman_temp_R&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;kalman_temp_Q&#39;</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
<span class="n">zs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">no_smoothing</span> <span class="c1"># Measurements</span>
<span class="n">P_0</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">x_0</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_1d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">P_0</span><span class="p">,</span> <span class="n">x_0</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$z$ measurements&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$ estimates&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">lowess_5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;lowess(5)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\sigma_{\hat</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R:</span><span class="si">{</span><span class="n">R</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1">. Q:</span><span class="si">{</span><span class="n">Q</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Change from baseline temp.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;global_temp_kalman&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.5
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.05
</pre></div>
</div>
<img alt="_images/7e198e5e81aaaaee47b0f630fdd0ca2fd24ef4c5de78e82bdcc6332c1998ed42.png" src="_images/7e198e5e81aaaaee47b0f630fdd0ca2fd24ef4c5de78e82bdcc6332c1998ed42.png" />
</div>
</div>
</section>
<section id="exploring-how-the-kalman-filter-behaves-with-data-gaps">
<span id="id8"></span><h3><span class="section-number">2.2.2. </span>Exploring how the kalman filter behaves with data gaps<a class="headerlink" href="#exploring-how-the-kalman-filter-behaves-with-data-gaps" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="c1"># Measurement variance</span>
<span class="n">Q</span> <span class="o">=</span> <span class="mf">0.03</span> <span class="c1"># Process noise variance</span>
<span class="n">zs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">no_smoothing</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># Measurements</span>

<span class="c1"># Define an data gap interval</span>
<span class="n">start</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1"># Years beyond 1880</span>
<span class="n">end</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">gap_zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
<span class="n">gap_zs</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_1d</span><span class="p">(</span><span class="n">gap_zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">P_0</span><span class="p">,</span> <span class="n">x_0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">gap_zs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$z$ measurements&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$ estimates&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\sigma_{\hat</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xs</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;kt_data_gap&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/80d8f1c5c1da42b3c26bdd850998d80b8b25deb1ffb5b6fcaf1006011fdad060.png" src="_images/80d8f1c5c1da42b3c26bdd850998d80b8b25deb1ffb5b6fcaf1006011fdad060.png" />
</div>
</div>
</section>
<section id="exploring-the-parameter-space-of-q-x-r">
<span id="exploring-param-space-1d"></span><h3><span class="section-number">2.2.3. </span>Exploring the parameter space of <span class="math notranslate nohighlight">\(Q\)</span> x <span class="math notranslate nohighlight">\(R\)</span><a class="headerlink" href="#exploring-the-parameter-space-of-q-x-r" title="Permalink to this heading">#</a></h3>
<p>Illustrating how the measurement noise covariance <span class="math notranslate nohighlight">\(R\)</span>, and process noise covariance is <span class="math notranslate nohighlight">\(Q\)</span> affect the behavior of the 1D Kalman filter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_temp_kalman_for_QR</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">P_0</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">x_0</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_1d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">P_0</span><span class="p">,</span> <span class="n">x_0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$z$ measurements&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$ estimates&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\sigma_{\hat</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Q:</span><span class="si">{</span><span class="n">Q</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1">. R:</span><span class="si">{</span><span class="n">R</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Low Q, High R</span>
<span class="n">Q</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;kt_lqhr_Q&#39;</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;kt_lqhr_R&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plot_temp_kalman_for_QR</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;kt_lqhr_fig&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># High Q, Low R</span>
<span class="n">Q</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.0</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;kt_hqlr_Q&#39;</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;kt_hqlr_R&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plot_temp_kalman_for_QR</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;kt_hqlr_fig&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fd918a6970adbbb7260efca3e2a233c65e6fc6fba86ffcdc1617176338d2bb51.png" src="_images/fd918a6970adbbb7260efca3e2a233c65e6fc6fba86ffcdc1617176338d2bb51.png" />
<img alt="_images/e9c8ebf180016ddb05ec2548dd46f026a4cc15b0c193c691852efa9a4cfffde7.png" src="_images/e9c8ebf180016ddb05ec2548dd46f026a4cc15b0c193c691852efa9a4cfffde7.png" />
</div>
</div>
</section>
</section>
<section id="the-bayesian-intuition-underlying-the-kalman-filter">
<h2><span class="section-number">2.3. </span>The Bayesian Intuition underlying the Kalman Filter<a class="headerlink" href="#the-bayesian-intuition-underlying-the-kalman-filter" title="Permalink to this heading">#</a></h2>
<p>In his excellent exploration of the Kalman Filter <span id="id9">[<a class="reference internal" href="bibliography.html#id4" title="Roger Labbe. Kalman and bayesian filters in python. https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python. Accessed: 2023-08-10.">Lab</a>]</span>, Roger Labbe illustrates the Bayesian intuition underlying the Kalman filter algorithm. I have implemented the Bayesian approach <a class="reference internal" href="code_appendix.html#bayesian-1d-kalman"><span class="std std-numref">Section 4.3</span></a>, and show it has the same result as the traditional implementation.</p>
</section>
<section id="multidimensional-kalman-filter-for-a-process-with-constant-acceleration">
<h2><span class="section-number">2.4. </span>Multidimensional Kalman Filter (for a Process With Constant Acceleration)<a class="headerlink" href="#multidimensional-kalman-filter-for-a-process-with-constant-acceleration" title="Permalink to this heading">#</a></h2>
<p>In this section I synthesize data for a object moving in 2 dimensions under a constant acceleration (due to gravity), then apply a multidimensional Kalman filter and analyze the filter’s output and accuracy.</p>
<section id="synthesizing-true-state-vec-x-k">
<span id="synth-true-state"></span><h3><span class="section-number">2.4.1. </span>Synthesizing true state <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span><a class="headerlink" href="#synthesizing-true-state-vec-x-k" title="Permalink to this heading">#</a></h3>
<p>We will track the following 6-dimensional state vector: <span class="math notranslate nohighlight">\(\vec{x} = \begin{bmatrix} x &amp; \dot{x} &amp; \ddot{x} &amp; y &amp; \dot{y} &amp; \ddot{y}\end{bmatrix}^T\)</span></p>
<p>Let’s start by defining a <em>deterministic</em> process model (simple Newtonian motion under constant acceleration) for state <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\vec{x}(k) =
\begin{bmatrix}
x(k) \\
\dot{x}(k) \\
\ddot{x}(k) \\
y(k) \\
\dot{y}(k) \\
\ddot{y}(k) \\
\end{bmatrix}
=
\begin{bmatrix}
1 &amp; \Delta t &amp; \frac{1}{2}(\Delta t)^2 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; \Delta t &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 1 &amp; \Delta t &amp; \frac{1}{2}(\Delta t)^2  \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; \Delta t \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \\
\end{bmatrix}
\begin{bmatrix}
x(k-1) \\
\dot{x}(k-1) \\
\ddot{x}(k-1) \\
y(k-1) \\
\dot{y}(k-1) \\
\ddot{y}(k-1) \\
\end{bmatrix}
=
F \vec{x}(k-1)
\end{split}\]</div>
<p>Where <span class="math notranslate nohighlight">\(F\)</span> is our transition matrix, <span class="math notranslate nohighlight">\(\vec{x}(k-1)\)</span> is the state at the previous time step, and <span class="math notranslate nohighlight">\(\Delta t\)</span> is the length of the time step.</p>
<p>Note that this implies constant acceleration in both dimensions. We’ll set our initial acceleration vector as acceleration due to gravity: <span class="math notranslate nohighlight">\(\begin{bmatrix} \ddot{x} &amp;  \ddot{y} \end{bmatrix}^T = \begin{bmatrix} 0 &amp;  -9.81 \end{bmatrix}^T \)</span></p>
<p>Now let’s simulate the trajectory of our deterministic process <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> over a period of time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulation config</span>

<span class="c1"># Timestep</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># Number of seconds of simulation</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">dt</span>
<span class="k">assert</span> <span class="n">N</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulating </span><span class="si">{</span><span class="n">T</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1"> seconds. </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s1"> timesteps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simulating 5.00 seconds. 50 timesteps
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial position</span>
<span class="n">x_0</span><span class="p">,</span> <span class="n">y_0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># Initial velocity</span>
<span class="n">vx_0</span><span class="p">,</span> <span class="n">vy_0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

<span class="c1"># Initial (constant) acceleration</span>
<span class="n">ax_0</span><span class="p">,</span> <span class="n">ay_0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">]</span>

<span class="c1"># Initial state</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># State dimensionality</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_0</span><span class="p">,</span> <span class="n">vx_0</span><span class="p">,</span> <span class="n">ax_0</span><span class="p">,</span> <span class="n">y_0</span><span class="p">,</span> <span class="n">vy_0</span><span class="p">,</span> <span class="n">ay_0</span><span class="p">])</span>

<span class="c1"># Transition matrix</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">],</span> 
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
<span class="p">])</span>

<span class="c1"># Results matrix. Each row is the state for one timestep</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x0</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">F</span> <span class="o">@</span> <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/84bf22a687cda0362cc6ad109b27360f85a29cc73813deddfe2b3936a2d43c25.png" src="_images/84bf22a687cda0362cc6ad109b27360f85a29cc73813deddfe2b3936a2d43c25.png" />
</div>
</div>
<p>This gives us a good foundation for our object’s motion. But we’re ultimately interested in a <em>stochastic</em> process: <span class="math notranslate nohighlight">\(\vec{x}(k) = F \vec{x}(k-1) + \vec{\eta}(k-1)\)</span></p>
<p>So let’s add <strong>noise</strong> <span class="math notranslate nohighlight">\(\vec{\eta}(k) \sim \mathcal{N}(0,Q)\)</span> to the process. We simplify/approximate a process noise covariance matrix that confines the variance to the acceleration components of the process:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Approximate Q as only variance for the acceleration components ax and ay.</span>
<span class="n">accel_var</span> <span class="o">=</span> <span class="mf">0.015</span>
<span class="n">Q_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">accel_var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">accel_var</span><span class="p">],</span>
<span class="p">])</span>

<span class="c1"># Results matrix. Each row is the state for one timestep</span>
<span class="n">true_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">true_xs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x0</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="c1"># Process noise - only affects acceleration</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">Q_true</span><span class="p">)</span>
    
    <span class="n">true_xs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">F</span> <span class="o">@</span> <span class="n">true_xs</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">eta</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;X-Y Track Of Object&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X position&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y position&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimated Acceleration Of Object&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X acceleration&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y acceleration&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/24f92080af331341c2f912a9b231dc00112db16dd6661996e4f8f8fe96b5d675.png" src="_images/24f92080af331341c2f912a9b231dc00112db16dd6661996e4f8f8fe96b5d675.png" />
</div>
</div>
</section>
<section id="synthesizing-measurements">
<h3><span class="section-number">2.4.2. </span>Synthesizing measurements<a class="headerlink" href="#synthesizing-measurements" title="Permalink to this heading">#</a></h3>
<p>To synthesize our measurement series <span class="math notranslate nohighlight">\(\vec{z}(k)\)</span>, we add bivariate white noise <span class="math notranslate nohighlight">\(\vec{\xi}(k) \sim \mathcal{N}(0,R)\)</span> to our synthesized true state series <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span>.</p>
<p>We will assume we only have positional sensors to take measurements, i.e. <span class="math notranslate nohighlight">\(\vec{z}(k) = [z_x(k), z_y(k)]^T\)</span>. As there are no velocity or acceleration components to our measurements, <span class="math notranslate nohighlight">\(\dot{x}\)</span>, <span class="math notranslate nohighlight">\(\ddot{x}\)</span>, <span class="math notranslate nohighlight">\(\dot{y}\)</span>, and <span class="math notranslate nohighlight">\(\ddot{y}\)</span> are all <em>hidden variables</em> (<span id="id10">[<a class="reference internal" href="bibliography.html#id4" title="Roger Labbe. Kalman and bayesian filters in python. https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python. Accessed: 2023-08-10.">Lab</a>]</span> Chpt. 5).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Synthesize measurements by adding random noise to the true position series</span>
<span class="n">z_var</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="c1"># Measurement (position) noise covariance matrix (independent bivariate normal)</span>
<span class="n">R_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="n">z_var</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_var</span><span class="p">],</span>
<span class="p">])</span>
<span class="n">zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">zs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_xs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># x positions</span>
<span class="n">zs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_xs</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="c1"># y positions</span>

<span class="n">zs</span> <span class="o">=</span> <span class="n">zs</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">R_true</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">zs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{z}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Synthesized measurement noise&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e544b18331feb1b1e239eddb8317c2c88b1c2cdddc5cb740071a439a22e1e86b.png" src="_images/e544b18331feb1b1e239eddb8317c2c88b1c2cdddc5cb740071a439a22e1e86b.png" />
</div>
</div>
</section>
<section id="multidimensional-filter-implementation">
<span id="multivar-kf-implementation"></span><h3><span class="section-number">2.4.3. </span>Multidimensional Filter Implementation<a class="headerlink" href="#multidimensional-filter-implementation" title="Permalink to this heading">#</a></h3>
<p>Now that we have our synthetic observations <span class="math notranslate nohighlight">\(\vec{z}(k)\)</span> we can apply a multivariate Kalman filter to obtain estimates <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> and do some analysis.</p>
<p>First we must implement that filter. The implementation below draws heavily from <span id="id11">[<a class="reference internal" href="bibliography.html#id4" title="Roger Labbe. Kalman and bayesian filters in python. https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python. Accessed: 2023-08-10.">Lab</a>]</span> Chpt. 6, extending that implementation to track 6 state variables instead of 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Matrix H converts state vectors into measurement space</span>
<span class="c1"># In this model, that means grabbing the position values</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">])</span>

<span class="k">def</span> <span class="nf">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
    <span class="c1"># Store filter estimates (means and variances)</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">Ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
    <span class="c1"># Initial estimate</span>
    <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x_0</span>
    <span class="n">Ps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_0</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span>

    <span class="c1"># TODO: Should we exclude prediction calculation for first iteration?</span>
    <span class="c1"># But we still want to do the correction for the first iteration, right?</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="c1"># 1) PREDICT</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">F</span> <span class="o">@</span> <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">F</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">F</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>

        <span class="c1"># 2) UPDATE</span>
        <span class="c1"># TODO: Currently using Labbe notation. Switch to Young?</span>

        <span class="c1"># Calculate system uncertainty</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">H</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span>

        <span class="c1"># Calculate kalman gain</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

        <span class="c1"># Calculate residual: Difference between prediction and measurement</span>
        <span class="c1"># (In measurement space)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">H</span> <span class="o">@</span> <span class="n">prior</span>

        <span class="c1"># Caculate posterior state (corrected estimate and covar)</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">y</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">P</span>

        <span class="c1"># Save</span>
        <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">post</span>
        <span class="n">Ps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
        
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span>

<span class="c1"># TODO: Known bug. When R and Q are zero matrices, the value of S&#39;s elements get tiny (floating</span>
<span class="c1"># point errors representing zero), which leads inv(S) to produce a matrix of nans. This produces</span>
<span class="c1"># nan estimates from that iteration onwards. Not sure how to avoid, but a workaround is to not pass</span>
<span class="c1"># in Q and R made of all zeros.</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="demonstration-on-synthetic-data">
<span id="multivar-kf-demo"></span><h3><span class="section-number">2.4.4. </span>Demonstration on synthetic data<a class="headerlink" href="#demonstration-on-synthetic-data" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize filter state</span>
<span class="c1"># Guess the position somewhat accurately, leave the velocity and acceleration state guesses as 0</span>
<span class="n">x_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">P_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span> <span class="c1"># Start with very low confidence in predictions</span>

<span class="c1"># Assume we can configure the system&#39;s process and measurement noise params correctly</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">Q_true</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">R_true</span>

<span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">)</span>
    
<span class="c1"># Extract covariances for position, velocity, and acceleration</span>
<span class="n">pos_vars</span><span class="p">,</span> <span class="n">vel_vars</span><span class="p">,</span> <span class="n">acc_vars</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_covar_series</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>
    
<span class="c1"># Plot track, measurements, and estimate for position</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">zs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{z}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Kalman position estimate&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x position&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y position&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;mv_kf_pos&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Plot track, measurements, and estimate for pos, vel, acc in a tight figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">3.5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">zs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{z}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Kalman position estimate&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x position&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y position&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Kalman velocity estimate&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x velocity&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y velocity&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Kalman acceleration estimate&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x acceleration&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y acceleration&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;mv_kf_pos_vel_acc&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Plot positional variance</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">3.5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">pos_vars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_x$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">pos_vars</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_y$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Position estimate variances&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma^2$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">vel_vars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_{\dot</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">vel_vars</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_{\dot</span><span class="si">{y}</span><span class="s1">}$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Velocity estimate variance&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma^2$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">acc_vars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_{\ddot</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">acc_vars</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_{\ddot</span><span class="si">{y}</span><span class="s1">}$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Acceleration estimate variance&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma^2$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;mv_kf_pva_variances&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># TODO could plot x and y pos, vel, and acc as functions of t.</span>
<span class="c1"># TODO Plot x(t) and vel_x(t) slopes overlaid</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9403d6286f10c1e30d26f1dc117c2da815d1c9cf99e64824123f0094f6378427.png" src="_images/9403d6286f10c1e30d26f1dc117c2da815d1c9cf99e64824123f0094f6378427.png" />
<img alt="_images/8ecd51ce0633a55e0d4ef7392c7bd1f52cd15c4a5114bb77ed618599dc0557de.png" src="_images/8ecd51ce0633a55e0d4ef7392c7bd1f52cd15c4a5114bb77ed618599dc0557de.png" />
<img alt="_images/ad77c6161464b27f6e8fea427d23472286a5e23881be280f569233402f3f0da2.png" src="_images/ad77c6161464b27f6e8fea427d23472286a5e23881be280f569233402f3f0da2.png" />
</div>
</div>
<p>The covariance matrix <span class="math notranslate nohighlight">\(P\)</span> (for a given k):</p>
<p><span class="math notranslate nohighlight">\(
P = \begin{bmatrix}
\sigma_{x}^2 &amp; \sigma_{x,\dot{x}}^2 &amp; \sigma_{x,\ddot{x}}^2 &amp; \sigma_{x,y}^2 &amp; \sigma_{x,\dot{y}}^2 &amp; \sigma_{x,\ddot{y}}^2  \\
\sigma_{\dot{x},x}^2 &amp; \sigma_{\dot{x}}^2 &amp; \sigma_{\dot{x},\ddot{x}}^2 &amp; \sigma_{\dot{x},y}^2 &amp; \sigma_{\dot{x},\dot{y}}^2 &amp; \sigma_{\dot{x},\ddot{y}}^2  \\
\sigma_{\ddot{x},x}^2 &amp; \sigma_{\ddot{x},\dot{x}}^2 &amp; \sigma_{\ddot{x}}^2 &amp; \sigma_{\ddot{x},y}^2 &amp; \sigma_{\ddot{x},\dot{y}}^2 &amp; \sigma_{\ddot{x},\ddot{y}}^2  \\
\sigma_{y,x}^2 &amp; \sigma_{y,\dot{x}}^2 &amp; \sigma_{y,\ddot{x}}^2 &amp; \sigma_{y}^2 &amp; \sigma_{y,\dot{y}}^2 &amp; \sigma_{y,\ddot{y}}^2  \\
\sigma_{\dot{y},x}^2 &amp; \sigma_{\dot{y},\dot{x}}^2 &amp; \sigma_{\dot{y},\ddot{x}}^2 &amp; \sigma_{\dot{y},y}^2 &amp; \sigma_{\dot{y}}^2 &amp; \sigma_{\dot{y},\ddot{y}}^2  \\
\sigma_{\ddot{y},x}^2 &amp; \sigma_{\ddot{y},\dot{x}}^2 &amp; \sigma_{\ddot{y},\ddot{x}}^2 &amp; \sigma_{\ddot{y},y}^2 &amp; \sigma_{\ddot{y},\dot{y}}^2 &amp; \sigma_{\ddot{y}}^2 
\end{bmatrix}
\)</span></p>
</section>
<section id="exploring-covariance-of-position-with-velocity">
<h3><span class="section-number">2.4.5. </span>Exploring covariance of position with velocity<a class="headerlink" href="#exploring-covariance-of-position-with-velocity" title="Permalink to this heading">#</a></h3>
<p>Below we see the <span class="math notranslate nohighlight">\(3 \sigma\)</span> ellipses for the covariance matrix of position with velocity
<span class="math notranslate nohighlight">\(\begin{bmatrix}
\sigma_{x,x}^2 &amp; \sigma_{x,\dot{x}}^2 \\
\sigma_{\dot{x},x}^2 &amp; \sigma_{\dot{x},\dot{x}}^2
\end{bmatrix}\)</span>
in the <span class="math notranslate nohighlight">\(x\)</span>-dimension for first few timesteps.</p>
<p>The visualization displays how the filter learns the covariance between position and the hidden variable velocity over time. It starts with prediction uncertainty as a wide variance fully uncorrelated (circular) ellipse, then converges over time to the way it looks in the end: with a positive covariance between position and velocity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract pos-vel covariance in the x dimension</span>
<span class="n">pos_vel_x_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ps</span><span class="p">)):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">pos_vel_x_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],[</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]])</span>

<span class="c1"># Plot</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> 
<span class="n">axes</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 

<span class="c1"># Plot prediction 3-sigma covariance ellipses</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">25</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">pos_vel_x_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">plot_covar_ellipse</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:</span><span class="n">steps</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:</span><span class="n">steps</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$[x,\dot</span><span class="si">{x}</span><span class="s1">]^T$ true&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:</span><span class="n">steps</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:</span><span class="n">steps</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$[x,\dot</span><span class="si">{x}</span><span class="s1">]^T$ estimated&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma_{x,\dot</span><span class="si">{x}</span><span class="s1">}^2$: x position-velocity covariance $3\sigma$ ellipses&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;x velocity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f717529c034bd149ccd5b7e29d9b40641b78489e68d217cc00530621ac062aa9.png" src="_images/f717529c034bd149ccd5b7e29d9b40641b78489e68d217cc00530621ac062aa9.png" />
</div>
</div>
</section>
<section id="quantifying-the-accuracy-of-the-kalman-filter-s-predictions">
<h3><span class="section-number">2.4.6. </span>Quantifying the Accuracy of the Kalman Filter’s Predictions<a class="headerlink" href="#quantifying-the-accuracy-of-the-kalman-filter-s-predictions" title="Permalink to this heading">#</a></h3>
<section id="nees-normalized-estimated-error-squared">
<span id="nees-implementation"></span><h4><span class="section-number">2.4.6.1. </span>NEES (Normalized Estimated Error Squared)<a class="headerlink" href="#nees-normalized-estimated-error-squared" title="Permalink to this heading">#</a></h4>
<p>NEES is one approach to quantifying the accuracy of the Kalman Filter’s estimates.</p>
<p>The NEES for time step <span class="math notranslate nohighlight">\(k\)</span> is <span class="math notranslate nohighlight">\(\epsilon(k) = \tilde{x}(k)^T \textbf{P}^{-1} \tilde{x}(k)\)</span>, where the error vector <span class="math notranslate nohighlight">\(\tilde{x}(k) = \vec{x}(k) - \hat{x}(k)\)</span>. Note this requires knowledge of the true state <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span>, which we have access to since we synthesized our input data.</p>
<p>In the below code, I</p>
<ol class="arabic simple">
<li><p>Calculate the NEES time series for my Kalman Filter implementation.</p></li>
<li><p>Show that this multidimensional filter implementation has a “good” average NEES score on my synthetic data (where “good” means the average NEES score is less than the dimension of the state vectors).</p></li>
<li><p>Numerically show that <span class="math notranslate nohighlight">\(\epsilon(k)\)</span> is chi-squared distributed with <span class="math notranslate nohighlight">\(n\)</span> degrees of freedom as is theoretically expected.</p></li>
</ol>
<p>References: <span id="id12">[<a class="reference internal" href="bibliography.html#id4" title="Roger Labbe. Kalman and bayesian filters in python. https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python. Accessed: 2023-08-10.">Lab</a>]</span>, <span id="id13">[<a class="reference internal" href="bibliography.html#id7" title="Yaakov Bar-Shalom, X Rong Li, and Thiagalingam Kirubarajan. Estimation with applications to tracking and navigation: theory algorithms and software. John Wiley &amp; Sons, 2001.">BSLK01</a>]</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xs_pos</span><span class="p">,</span> <span class="n">xs_vel</span><span class="p">,</span> <span class="n">xs_acc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">true_xs_vel</span><span class="p">,</span> <span class="n">true_xs_acc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span>
<span class="n">Ps_pos</span><span class="p">,</span> <span class="n">Ps_vel</span><span class="p">,</span> <span class="n">Ps_acc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_covar_series</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>

<span class="c1"># Calculate the NEES series</span>
<span class="k">def</span> <span class="nf">nees_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">):</span>
    <span class="n">x_tilde</span> <span class="o">=</span> <span class="n">true_xs</span> <span class="o">-</span> <span class="n">xs</span>
    <span class="n">nees_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> <span class="c1"># TODO can we vectorize this loop?</span>
        <span class="n">nees_ts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Ps</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">@</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">nees_ts</span>
        
<span class="c1"># Calculate the mean NEES score</span>
<span class="k">def</span> <span class="nf">mean_nees</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">):</span>
    <span class="n">nees_ts</span> <span class="o">=</span> <span class="n">nees_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)</span>

<span class="c1">## COMPLETE state vector NEES</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">nees_ts</span> <span class="o">=</span> <span class="n">nees_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">nees_ts</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Complete state NEES&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">,\dot</span><span class="si">{x}</span><span class="s1">,\ddot</span><span class="si">{x}</span><span class="s1">$  NEES&#39;</span><span class="p">)</span>

<span class="c1"># Complete state NEES distribution compared to chi-2</span>
<span class="n">domain</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)))</span>
<span class="c1"># Set the number of histogram bins so each has width unity</span>
<span class="n">num_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">h_vals</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h_vals</span><span class="p">)</span>
<span class="n">domain_ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">domain_ls</span><span class="p">,</span> <span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">domain_ls</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\chi^2_6$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\epsilon(k) values$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;density&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparing numerical and theoretical distributions&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># A &#39;good&#39; NEES score is: the average value of the NEES timeseries is less than the dimension of the state vector</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Complete state mean NEES score: </span><span class="si">{</span><span class="n">mean_nees</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">Ps</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># POSITION NEES</span>
<span class="c1"># The difference between the estimate and the true position state</span>
<span class="n">nees_ts</span> <span class="o">=</span> <span class="n">nees_series</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">nees_ts</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Position state NEES&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$  NEES&#39;</span><span class="p">)</span>

<span class="c1"># Position NEES distribution compared to chi-2</span>
<span class="n">domain</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)))</span>
<span class="c1"># Set the number of histogram bins so each has width unity</span>
<span class="n">num_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">h_vals</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h_vals</span><span class="p">)</span>
<span class="n">domain_ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">domain_ls</span><span class="p">,</span> <span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">domain_ls</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\chi^2_2$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\epsilon(k) values$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;density&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparing numerical and theoretical distributions&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Position state mean NEES score: </span><span class="si">{</span><span class="n">mean_nees</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span><span class="w"> </span><span class="n">xs_pos</span><span class="p">,</span><span class="w"> </span><span class="n">Ps_pos</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># VELOCITY NEES</span>
<span class="n">nees_ts</span> <span class="o">=</span> <span class="n">nees_series</span><span class="p">(</span><span class="n">true_xs_vel</span><span class="p">,</span> <span class="n">xs_vel</span><span class="p">,</span> <span class="n">Ps_vel</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">nees_ts</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Velocity state NEES&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\dot</span><span class="si">{x}</span><span class="s1">$  NEES&#39;</span><span class="p">)</span>

<span class="c1"># ACCELERATION NEES</span>
<span class="n">nees_ts</span> <span class="o">=</span> <span class="n">nees_series</span><span class="p">(</span><span class="n">true_xs_acc</span><span class="p">,</span> <span class="n">xs_acc</span><span class="p">,</span> <span class="n">Ps_acc</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">nees_ts</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Acceleration state NEES&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ddot</span><span class="si">{x}</span><span class="s1">$  NEES&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Velocity state mean NEES score: </span><span class="si">{</span><span class="n">mean_nees</span><span class="p">(</span><span class="n">true_xs_vel</span><span class="p">,</span><span class="w"> </span><span class="n">xs_vel</span><span class="p">,</span><span class="w"> </span><span class="n">Ps_vel</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acceleration state mean NEES score: </span><span class="si">{</span><span class="n">mean_nees</span><span class="p">(</span><span class="n">true_xs_acc</span><span class="p">,</span><span class="w"> </span><span class="n">xs_acc</span><span class="p">,</span><span class="w"> </span><span class="n">Ps_acc</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/86deb4fca00e8ff160850fef0a6821e94816cf9e0e96f332c1575c23af164faa.png" src="_images/86deb4fca00e8ff160850fef0a6821e94816cf9e0e96f332c1575c23af164faa.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Complete state mean NEES score: 5.615083226038849
</pre></div>
</div>
<img alt="_images/87552dcac89854285536f12cca70fab4bb15f57bbcb195f7ae22ea36f2f84218.png" src="_images/87552dcac89854285536f12cca70fab4bb15f57bbcb195f7ae22ea36f2f84218.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Position state mean NEES score: 1.8521419590449708
</pre></div>
</div>
<img alt="_images/504656c67b0da56d0e51d3482cc50a671db8497214c7df41067fcc38e8636076.png" src="_images/504656c67b0da56d0e51d3482cc50a671db8497214c7df41067fcc38e8636076.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Velocity state mean NEES score: 2.893379246281296
Acceleration state mean NEES score: 2.503600489582321
</pre></div>
</div>
</div>
</div>
<p>Above we have shown:</p>
<ul class="simple">
<li><p>The full state vector <span class="math notranslate nohighlight">\(\vec{x}\)</span> (as well as the split out position, velocity, and accelerate state 2-tuples) comply with the <span class="math notranslate nohighlight">\(\chi^2_k\)</span> distributions, and that the average value of the NEES series is less than the number of elements in the respective state vector.</p></li>
<li><p>The state vectors <span class="math notranslate nohighlight">\(\epsilon(k)\)</span> distributions are indeed <span class="math notranslate nohighlight">\(\chi^2_k\)</span>, verified by overlaying the actual NEES values histogram with the <span class="math notranslate nohighlight">\(\chi^2_k\)</span> pdfs.</p></li>
</ul>
</section>
<section id="sigma-membership-accuracy-score-do-the-true-positions-vec-x-k-fall-within-the-hat-x-k-estimates-3-sigma-confidence-ellipses">
<span id="sig-membership-implementation"></span><h4><span class="section-number">2.4.6.2. </span><span class="math notranslate nohighlight">\(3\sigma\)</span> Membership Accuracy Score: Do the true positions <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> fall within the <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> estimates’ <span class="math notranslate nohighlight">\(3\sigma\)</span> confidence ellipses?<a class="headerlink" href="#sigma-membership-accuracy-score-do-the-true-positions-vec-x-k-fall-within-the-hat-x-k-estimates-3-sigma-confidence-ellipses" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Return a boolean array, where each element encodes whether the k-th true</span>
<span class="c1"># state is within n-std confidence ellipse of the k-th estimate.</span>
<span class="c1"># Only works for 2D state</span>
<span class="k">def</span> <span class="nf">within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args: </span>
<span class="sd">            xs: State estimate array</span>
<span class="sd">            true_xs: True state array</span>
<span class="sd">            Ps: Estimate covariance array</span>
<span class="sd">            n_std: Number of standard deviations defining the covar ellipse size</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Ps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ellipse_contains</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">Ps</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">n_std</span><span class="o">=</span><span class="n">n_std</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">ratio_within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">):</span>
    <span class="n">accurate_ellipses</span> <span class="o">=</span> <span class="n">within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">accurate_ellipses</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">accurate_ellipses</span><span class="p">)</span>

<span class="c1"># Visualize the accuracy of 2D state estimates as whether their 2x2 covariance ellipses</span>
<span class="c1"># contain the true state values.</span>
<span class="k">def</span> <span class="nf">plot_3sig_membership_acccuracy</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="c1"># Plot positional estimates with 3sigma ellipses</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 

    <span class="c1"># Plot estimated and true state</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Plot estimates&#39; 3-sigma elipses</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">plot_covar_ellipse</span><span class="p">(</span><span class="n">Ps</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

    <span class="c1"># Calculate whether k-th true value falls within k-th estimates ellipse</span>
    <span class="n">accurate_ellipses</span> <span class="o">=</span> <span class="n">within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="c1"># Plot line segments connecting each estimate to its true value for time k</span>
    <span class="n">line_segs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">line_segs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>

    <span class="c1"># Color line segments based on the estimate accuracy</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">accurate_ellipses</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">LineCollection</span><span class="p">(</span><span class="n">line_segs</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$|\vec</span><span class="si">{x}</span><span class="s1">-\hat</span><span class="si">{x}</span><span class="s1">|$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$3 \sigma$ Membership Accuracy&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Percent of estimate covar ellipse containing true state: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">accurate_ellipses</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">N</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    
<span class="c1"># Demonstrate with x-y position state estimates</span>
<span class="n">Q_scale</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">R_scale</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">Q_true</span> <span class="o">*</span> <span class="n">Q_scale</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">R_true</span> <span class="o">*</span> <span class="n">R_scale</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Q * </span><span class="si">{</span><span class="n">Q_scale</span><span class="si">:</span><span class="s1">.01f</span><span class="si">}</span><span class="s1">.  R * </span><span class="si">{</span><span class="n">R_scale</span><span class="si">:</span><span class="s1">.01f</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

<span class="c1"># Run Kalman filter for (Q,R) combo</span>
<span class="n">P_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span> <span class="c1"># Start with very low confidence in predictions</span>
<span class="n">v_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># Start with an ok initial state</span>
<span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">v_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">)</span>

<span class="n">xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span>
<span class="n">Ps_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_covar_series</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plot_3sig_membership_acccuracy</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> 
                     <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x position&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;y position&#39;</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;3sig_membership_viz&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio_within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;3sm_ratio&#39;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R:</span><span class="se">\n</span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="se">\n</span><span class="s1">Q:</span><span class="se">\n</span><span class="si">{</span><span class="n">Q</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 5.0.  R * 0.2.
</pre></div>
</div>
<img alt="_images/9d7cb9f84f850c68cab32d92e82155c0eda567929d7486c6de02796ea449ab2e.png" src="_images/9d7cb9f84f850c68cab32d92e82155c0eda567929d7486c6de02796ea449ab2e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 80.00%
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R:
[[0.3 0. ]
 [0.  0.3]]
Q:
[[0.    0.    0.    0.    0.    0.   ]
 [0.    0.    0.    0.    0.    0.   ]
 [0.    0.    0.075 0.    0.    0.   ]
 [0.    0.    0.    0.    0.    0.   ]
 [0.    0.    0.    0.    0.    0.   ]
 [0.    0.    0.    0.    0.    0.075]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="exploring-residuals">
<h4><span class="section-number">2.4.6.3. </span>Exploring Residuals<a class="headerlink" href="#exploring-residuals" title="Permalink to this heading">#</a></h4>
<p>Another simple way to gain intuition about the filter’s accuracy is to visualize the residuals <span class="math notranslate nohighlight">\(\vec{x}(k)-\hat{x}(k)\)</span>, or their norms:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># rs = true_xs - xs</span>
<span class="c1"># Note this function assumes the given ax is part of a multi subplot figure</span>
<span class="k">def</span> <span class="nf">plot_residuals</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">rs_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">rs_norms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">rs_norms</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residual norm (log scale)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>

<span class="c1"># Calculate and plot residuals for multiple (track, estimate) pairs on one figure</span>
<span class="k">def</span> <span class="nf">plot_all_residuals_2</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">estimates</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        tracks: List of true state timeseries</span>
<span class="sd">        estimates: List of estimated state timeseries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">track</span><span class="p">,</span> <span class="n">estimate</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">estimates</span><span class="p">):</span>
        <span class="n">xs_pos</span><span class="p">,</span> <span class="n">xs_vel</span><span class="p">,</span> <span class="n">xs_acc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">true_xs_vel</span><span class="p">,</span> <span class="n">true_xs_acc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">estimate</span><span class="p">)</span>

        <span class="c1"># Complete Residuals</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">track</span> <span class="o">-</span> <span class="n">estimate</span>
        <span class="n">plot_residuals</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Complete $\vec</span><span class="si">{x}</span><span class="s1">$ Residuals&#39;</span><span class="p">)</span>

        <span class="c1"># Position residuals</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">true_xs_pos</span> <span class="o">-</span> <span class="n">xs_pos</span>
        <span class="n">plot_residuals</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Position Residuals&#39;</span><span class="p">)</span>

        <span class="c1"># Velocity residuals</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">true_xs_vel</span> <span class="o">-</span> <span class="n">xs_vel</span>
        <span class="n">plot_residuals</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Velocity Residuals&#39;</span><span class="p">)</span>

        <span class="c1"># Velocity residuals</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">true_xs_acc</span> <span class="o">-</span> <span class="n">xs_acc</span>
        <span class="n">plot_residuals</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Acceleration Residuals&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_all_residuals_2</span><span class="p">([</span><span class="n">true_xs</span><span class="p">],</span> <span class="p">[</span><span class="n">xs</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/455e8d2463543952889f4bd1093aa2e6929696ee298293022e37d3c6c405572d.png" src="_images/455e8d2463543952889f4bd1093aa2e6929696ee298293022e37d3c6c405572d.png" />
</div>
</div>
</section>
</section>
<section id="visualizing-the-3-sigma-membership-accuracy-score-as-a-function-of-initial-state-guess-perturbation">
<span id="init-state-pertub"></span><h3><span class="section-number">2.4.7. </span>Visualizing the <span class="math notranslate nohighlight">\(3 \sigma\)</span> membership accuracy score as a function of initial state guess perturbation<a class="headerlink" href="#visualizing-the-3-sigma-membership-accuracy-score-as-a-function-of-initial-state-guess-perturbation" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">num_incr</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">samples_per_incr</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># For each initial state guess perturbation scale, we&#39;ll track the 3-sigma membership</span>
<span class="c1"># accuracy score.</span>
<span class="n">accuracy_3sm</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">accuracy_nees</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For p in a set of increasing distances (relative scale to true x0&#39;s norm)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_incr</span><span class="p">):</span>    
    <span class="c1"># Generate random initial state vectors perturbed by p from true initial state x0</span>
    <span class="c1"># via the Muller method.</span>
    <span class="n">x0_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">x0_norm</span> <span class="o">*</span> <span class="n">p</span>
    <span class="n">init_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">samples_per_incr</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_per_incr</span><span class="p">):</span>
        <span class="n">init_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">random_point_on_dsphere</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">true_xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Run Kalman filter and check accuracy for each initial (position) state guess</span>
    <span class="k">for</span> <span class="n">v_0</span> <span class="ow">in</span> <span class="n">init_points</span><span class="p">:</span>
        <span class="n">P_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span> <span class="c1"># Start with very low confidence in predictions</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">v_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">)</span>
        <span class="n">xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span>
        <span class="n">Ps_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_covar_series</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio_within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">)</span>
        <span class="n">accuracy_3sm</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">ratio</span><span class="p">))</span>
        <span class="c1"># TODO Calculate accuracy ratios for velocity and acceleration also?</span>
        <span class="c1"># Calculate mean NEES score</span>
        <span class="n">accuracy_nees</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">mean_nees</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">)))</span>
        
<span class="n">accuracy_3sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accuracy_3sm</span><span class="p">)</span>
<span class="n">accuracy_nees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accuracy_nees</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">accuracy_3sm</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_incr</span> <span class="o">*</span> <span class="n">samples_per_incr</span>

<span class="c1"># Calculate mean accuracy score for each perturbation scale value</span>
<span class="c1"># Had to do so manually because I couldn&#39;t get np&#39;s 2D Histogram working</span>
<span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">accuracy_3sm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">avg_y_vals_3sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">))</span>
<span class="n">avg_y_vals_nees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">))</span>
<span class="n">d_3sm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">))]))</span>
<span class="n">d_nees</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">))]))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">accuracy_3sm</span><span class="p">)):</span>
    <span class="n">p</span><span class="p">,</span> <span class="n">score_3sm</span> <span class="o">=</span> <span class="n">accuracy_3sm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">d_3sm</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_3sm</span><span class="p">)</span>
    <span class="n">p</span><span class="p">,</span> <span class="n">score_nees</span> <span class="o">=</span> <span class="n">accuracy_nees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">d_nees</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_nees</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">y_vals_3sm</span> <span class="o">=</span> <span class="n">d_3sm</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="n">avg_y_vals_3sm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_vals_3sm</span><span class="p">)</span>
    <span class="n">y_vals_nees</span> <span class="o">=</span> <span class="n">d_nees</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="n">avg_y_vals_nees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_vals_nees</span><span class="p">)</span>

<span class="c1"># Plot 3-sigma membership accuracy vs perturbation scale</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">accuracy_3sm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">accuracy_3sm</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">avg_y_vals_3sm</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Avg. Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Initial State Guess Perturbation Scale&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$3 \sigma$ Membership Accuracy Score&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;$3 \sigma$ Membership Accuracy vs. Perturbation Scale&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;3sm_v_perturbation&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Plot NEES mean accuracy vs perturbation scale</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">accuracy_nees</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">accuracy_nees</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">avg_y_vals_nees</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Avg. Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Initial State Guess Perturbation Scale&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Mean NEES Accuracy Score&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Mean NEES Accuracy vs. Perturbation Scale&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;nees_v_perturbation&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/547a3e1708760691f77e5038c7dbe2e7696d631b26ba3c3ff1e3a4ecff1590aa.png" src="_images/547a3e1708760691f77e5038c7dbe2e7696d631b26ba3c3ff1e3a4ecff1590aa.png" />
<img alt="_images/8b0eb493465fce5c1089d8a3d1ad0d622895ebbf2bd9d0303edc38f3d1c0061e.png" src="_images/8b0eb493465fce5c1089d8a3d1ad0d622895ebbf2bd9d0303edc38f3d1c0061e.png" />
</div>
</div>
</section>
<section id="exploring-q-r-parameter-space-for-the-multivariable-kalman-filter-example">
<span id="qr-param-space"></span><h3><span class="section-number">2.4.8. </span>Exploring <span class="math notranslate nohighlight">\(Q\)</span>,<span class="math notranslate nohighlight">\(R\)</span> parameter space for the multivariable Kalman filter example<a class="headerlink" href="#exploring-q-r-parameter-space-for-the-multivariable-kalman-filter-example" title="Permalink to this heading">#</a></h3>
<p>In our initial exploration, we assumed we could configure the filter’s <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(R\)</span> values perfectly (i.e. to the noise values that were used to generate the synthetic data). But what about the more realistic scenario where we don’t know the true <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(R\)</span> values?</p>
<p>Let <span class="math notranslate nohighlight">\(Q*\)</span> and <span class="math notranslate nohighlight">\(R*\)</span> be the true process and measurement noise covariance matrices, respectively. Below we explore tuning <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(R\)</span> (the parameters passed to the filter) covariance matrices to an increasing range of scaling factors applied to <span class="math notranslate nohighlight">\(Q*\)</span> and <span class="math notranslate nohighlight">\(R*\)</span>. For each point in our (<span class="math notranslate nohighlight">\(Q\)</span>,<span class="math notranslate nohighlight">\(R\)</span>) parameter space, we run the Kalman filter on the synthetic data set and evaluate its accuracy (via <a class="reference internal" href="#accuracy-metrics"><span class="std std-ref">both metrics</span></a>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the kalman filter and compute the both the 3sigma membership and NEES accuracy</span>
<span class="c1"># scores for position state estimates for the given Q_scale and R_scale factor</span>
<span class="k">def</span> <span class="nf">calc_accuracy_scores</span><span class="p">(</span><span class="n">Q_scale</span><span class="p">,</span> <span class="n">R_scale</span><span class="p">):</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q_true</span> <span class="o">*</span> <span class="n">Q_scale</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R_true</span> <span class="o">*</span> <span class="n">R_scale</span>

    <span class="c1"># Run Kalman filter for (Q,R) combo</span>
    <span class="n">P_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span> <span class="c1"># Start with very low confidence in predictions</span>
    <span class="n">v_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># Start with an ok initial state</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">v_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">)</span>

    <span class="n">xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span>
    <span class="n">Ps_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_covar_series</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="c1"># Calculate accuracy scores</span>
    <span class="n">accuracy_3sm</span> <span class="o">=</span> <span class="n">ratio_within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">)</span>
    <span class="n">accuracy_nees</span> <span class="o">=</span> <span class="n">mean_nees</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">accuracy_3sm</span><span class="p">,</span> <span class="n">accuracy_nees</span><span class="p">)</span>

<span class="c1"># Iterate through the (Q,R) parameter space </span>
<span class="c1"># In terms of percentages of the true param values</span>
<span class="n">num_iters</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># The Q and R matrices are simple, they can be represented by their top left corner</span>
<span class="c1"># i.e. the variance of the x position</span>
<span class="n">Q_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">6</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span>
<span class="n">R_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span>

<span class="c1"># Meshgrid it and calculate surface of accuracy scores (for both 3sigma membership and NEES)</span>
<span class="n">QQ_scales</span><span class="p">,</span> <span class="n">RR_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">Q_scales</span><span class="p">,</span> <span class="n">R_scales</span><span class="p">)</span>
<span class="n">accuracy_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">calc_accuracy_scores</span><span class="p">)(</span><span class="n">QQ_scales</span><span class="p">,</span> <span class="n">RR_scales</span><span class="p">)</span>
<span class="n">scores_3sm</span><span class="p">,</span> <span class="n">scores_nees</span> <span class="o">=</span> <span class="n">accuracy_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">accuracy_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Plot 3-sigma membership accuracy score surface and contour map</span>
<span class="c1">#fig = plt.figure(figsize=plt.figaspect(0.5))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">8.5</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">QQ_scales</span><span class="p">,</span> <span class="n">RR_scales</span><span class="p">,</span> <span class="n">scores_3sm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Q Scale&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R Scale&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$3 \sigma$ Membership Score vs.&#39;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s1">&#39;(Q,R) Perturbation Scale&#39;</span><span class="p">)</span>
        
<span class="c1"># Plot mean NEES accuracy score surface</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">QQ_scales</span><span class="p">,</span> <span class="n">RR_scales</span><span class="p">,</span> <span class="n">scores_nees</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">roll</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Q Scale&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R Scale&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;NEES Membership Score vs.&#39;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s1">&#39;(Q,R) Perturbation Scale&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">glue</span><span class="p">(</span><span class="s1">&#39;acc_surface_fig&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f8cb365c35ffd59c4d68b63043a7fa36fd5e4bea39b20bc6c025f635c1539e19.png" src="_images/f8cb365c35ffd59c4d68b63043a7fa36fd5e4bea39b20bc6c025f635c1539e19.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "jb"
        },
        kernelOptions: {
            name: "jb",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'jb'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">The Kalman Filter</p>
      </div>
    </a>
    <a class="right-next"
       href="bibliography.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Bibliography</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">1. Writeup</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-1d-kalman-filter">1.1. The 1D Kalman Filter</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">1.1.1. Implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#demonstration-on-temperature-data">1.1.2. Demonstration on temperature data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-linear-kalman-filter-applied-to-non-linear-data">1.1.3. A linear kalman filter applied to non-linear data?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#behavior-in-the-presence-of-data-gaps">1.1.4. Behavior in the presence of data gaps</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-multivariate-kalman-filter">1.2. The Multivariate Kalman Filter</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-and-synthesis-of-input-data">1.2.1. Implementation and synthesis of input data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#accuracy-metrics">1.2.2. Accuracy Metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#normalized-estimated-error-squared-nees">1.2.2.1. Normalized Estimated Error Squared (NEES)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sigma-membership-accuracy-score">1.2.2.2. <span class="math notranslate nohighlight">\(3 \sigma\)</span> Membership Accuracy Score</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performance">1.2.3. Performance</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-state-estimate-perturbation">1.2.3.1. Initial state estimate perturbation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#q-r-perturbation-from-their-true-values">1.2.3.2. <span class="math notranslate nohighlight">\(Q\)</span>,<span class="math notranslate nohighlight">\(R\)</span> perturbation from their true values.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">1.3. Conclusion</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#code">2. Code</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#global-temp-anomaly-data">2.1. Global Temp Anomaly Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">2.2. The 1D Kalman Filter</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-kalman-implementation">2.2.1. Implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-how-the-kalman-filter-behaves-with-data-gaps">2.2.2. Exploring how the kalman filter behaves with data gaps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-parameter-space-of-q-x-r">2.2.3. Exploring the parameter space of <span class="math notranslate nohighlight">\(Q\)</span> x <span class="math notranslate nohighlight">\(R\)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-bayesian-intuition-underlying-the-kalman-filter">2.3. The Bayesian Intuition underlying the Kalman Filter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multidimensional-kalman-filter-for-a-process-with-constant-acceleration">2.4. Multidimensional Kalman Filter (for a Process With Constant Acceleration)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthesizing-true-state-vec-x-k">2.4.1. Synthesizing true state <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthesizing-measurements">2.4.2. Synthesizing measurements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multidimensional-filter-implementation">2.4.3. Multidimensional Filter Implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#demonstration-on-synthetic-data">2.4.4. Demonstration on synthetic data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-covariance-of-position-with-velocity">2.4.5. Exploring covariance of position with velocity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-the-accuracy-of-the-kalman-filter-s-predictions">2.4.6. Quantifying the Accuracy of the Kalman Filter’s Predictions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nees-normalized-estimated-error-squared">2.4.6.1. NEES (Normalized Estimated Error Squared)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sigma-membership-accuracy-score-do-the-true-positions-vec-x-k-fall-within-the-hat-x-k-estimates-3-sigma-confidence-ellipses">2.4.6.2. <span class="math notranslate nohighlight">\(3\sigma\)</span> Membership Accuracy Score: Do the true positions <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> fall within the <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> estimates’ <span class="math notranslate nohighlight">\(3\sigma\)</span> confidence ellipses?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-residuals">2.4.6.3. Exploring Residuals</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-3-sigma-membership-accuracy-score-as-a-function-of-initial-state-guess-perturbation">2.4.7. Visualizing the <span class="math notranslate nohighlight">\(3 \sigma\)</span> membership accuracy score as a function of initial state guess perturbation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-q-r-parameter-space-for-the-multivariable-kalman-filter-example">2.4.8. Exploring <span class="math notranslate nohighlight">\(Q\)</span>,<span class="math notranslate nohighlight">\(R\)</span> parameter space for the multivariable Kalman filter example</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By David Ouyang Moench
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>
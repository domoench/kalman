

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Kalman Filters &#8212; SDEs Project - Kalman Filters</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'kalman';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="#">
  
  
  
  
  
    <p class="title logo__title">SDEs Project - Kalman Filters</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    Kalman Filters
                </a>
            </li>
        </ul>
        
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fkalman.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/kalman.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Kalman Filters</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Kalman Filters</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#high-level-concepts">High Level Concepts</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-bayesian-intuition-underlying-the-kalman-filter">The Bayesian Intuition underlying the Kalman Filter</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-1d-kalman-filter">Implementing the 1D Kalman Filter</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demonstration-on-temperature-data">Demonstration on temperature data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-linear-kalman-filter-applied-to-non-linear-data">A linear kalman filter applied to non-linear data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#code">CODE</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#global-temp-anomaly-data">Global Temp Anomaly Data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#bayesian-style-implementation">Bayesian Style Implementation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#rewriting-in-standard-notation">Rewriting in Standard notation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-how-the-kalman-filter-behaves-with-data-gaps">Exploring how the kalman filter behaves with data gaps</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-parameter-space-of-q-x-r">Exploring the parameter space of <span class="math notranslate nohighlight">\(Q\)</span> x <span class="math notranslate nohighlight">\(R\)</span></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#d-kalman-for-process-with-constant-acceleration">2D Kalman for Process With Constant Acceleration</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#multidimensional-linear-kalman-filter">Multidimensional linear kalman filter</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synthesizing-measurements">Synthesizing measurements</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#do-the-true-positions-vec-x-k-fall-within-the-hat-x-k-estimates-3-sigma-confidence-ellipses">Do the true positions <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> fall within the <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> estimates’ <span class="math notranslate nohighlight">\(3\sigma\)</span> confidence ellipses?</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-covariance-of-position-with-velocity">Exploring covariance of position with velocity</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-the-accuracy-of-the-kalman-filter-s-predictions">Quantifying the Accuracy of the Kalman Filter’s Predictions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nees">NEES</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-residuals">Exploring Residuals</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-initial-state-guess-perturbations">Exploring initial state guess perturbations</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-parameter-space-for-the-multivariable-kalman-filter-example">Exploring parameter space for the multivariable kalman filter example</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#bibliography">Bibliography</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="kalman-filters">
<h1>Kalman Filters<a class="headerlink" href="#kalman-filters" title="Permalink to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="high-level-concepts">
<h1>High Level Concepts<a class="headerlink" href="#high-level-concepts" title="Permalink to this heading">#</a></h1>
<p>Fundamentally, the Kalman Filter is an algorithm that solves the <em>filtering problem</em>. The filtering problem involves finding the best estimate <span class="math notranslate nohighlight">\(\hat{x}(t)\)</span> of some true process <span class="math notranslate nohighlight">\(\vec{x}(t)\)</span> given noisy measurements <span class="math notranslate nohighlight">\(\vec{z}(t)\)</span>. There are 2 sources of stochastic noise: process noise (noise within <span class="math notranslate nohighlight">\(\vec{x}(t)\)</span> itself) and measurement noise.</p>
<p>To simplify the discussion, we will makes some assumptions:</p>
<ul class="simple">
<li><p>Both forms of noise are gaussian and time-invariant. Both are white noise: the process noise covariance matrix <span class="math notranslate nohighlight">\(Q\)</span> and measurement noise covariance matrix <span class="math notranslate nohighlight">\(R\)</span> are diagonal matrices.</p></li>
<li><p>The process is linear</p></li>
</ul>
<p>Under such assumptions we can represent our process and measurements as follows:</p>
<p><span class="math notranslate nohighlight">\(
\vec{x}(k) = F \vec{x}(k-1) + \vec{\eta}(k)
\\
\vec{z}(k) = H \vec{x}(k) + \vec{\xi}(k)
\)</span></p>
<p>Where <span class="math notranslate nohighlight">\(\vec{\eta}(k) \sim \mathcal{N}(0, Q)\)</span> and <span class="math notranslate nohighlight">\(\vec{\xi}(k) \sim \mathcal{N}(0, R)\)</span></p>
<p><span id="id1">[<a class="reference internal" href="#id8" title="Peter C Young. Recursive estimation and time-series analysis: An introduction for the student and practitioner. Springer Science &amp; Business Media, 2011.">You11</a>]</span> (4.44).</p>
<p>The Kalman Filter algorithm can be summarized as follows. At the <span class="math notranslate nohighlight">\(k\)</span>-th iteration:</p>
<ol class="arabic simple">
<li><p>Prediction Step</p>
<ul class="simple">
<li><p>Make a prediction <span class="math notranslate nohighlight">\(\hat{x}(k | k-1)\)</span> of the value of state <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> based on the process model and previous state estimate <span class="math notranslate nohighlight">\(\vec{x}(k-1)\)</span></p></li>
<li><p>Update covariance <span class="math notranslate nohighlight">\(P\)</span>, which quantifies the uncertainty of our estimate, based on the previous value of <span class="math notranslate nohighlight">\(P\)</span> and the process noise covariance <span class="math notranslate nohighlight">\(Q\)</span>.</p></li>
</ul>
</li>
<li><p>Update Step: Incorporating the measurement <span class="math notranslate nohighlight">\(\vec{z}(k)\)</span></p>
<ul class="simple">
<li><p>Update the prediction <span class="math notranslate nohighlight">\(\hat{x}(k | k-1)\)</span> with the information <span class="math notranslate nohighlight">\(\vec{z}(k)\)</span>. The estimate <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> will fall along the residual between the prediction and measurement. The uncertainties of the measurement and prediction are used to calculate the Kalman Gain, which scales how far long that residual vector the estimate <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> will fall. For example, if the measurement’s uncertainty (quantified by <span class="math notranslate nohighlight">\(R\)</span>) is much less than the prediction’s uncertainty (quantified by <span class="math notranslate nohighlight">\(P\)</span>), <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> will fall much closer to <span class="math notranslate nohighlight">\(\vec{z}(k)\)</span>.</p></li>
</ul>
</li>
</ol>
<p>The exact formulas for the algorithm outlined above can be found in <span id="id2">[<a class="reference internal" href="#id8" title="Peter C Young. Recursive estimation and time-series analysis: An introduction for the student and practitioner. Springer Science &amp; Business Media, 2011.">You11</a>]</span> Chapter 4.4.</p>
<section id="the-bayesian-intuition-underlying-the-kalman-filter">
<h2>The Bayesian Intuition underlying the Kalman Filter<a class="headerlink" href="#the-bayesian-intuition-underlying-the-kalman-filter" title="Permalink to this heading">#</a></h2>
<p>In his excellent exploration of the Kalman Filter <span id="id3">[<a class="reference internal" href="#id9" title="Roger Labbe. Kalman and bayesian filters in python. https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python. Accessed: 2023-08-10.">Lab</a>]</span>, Roger Labbe illustrates the bayesian intuition underlying the kalman filter algorithm.</p>
<p><strong>TODO</strong> explaining the Bayesian connection is a nice to have, save it for after the core presentation of your implementations is done.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="implementing-the-1d-kalman-filter">
<h1>Implementing the 1D Kalman Filter<a class="headerlink" href="#implementing-the-1d-kalman-filter" title="Permalink to this heading">#</a></h1>
<p>Here we implement the 1D Kalman filter and apply it to a simple problem involving global temperature data.</p>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">#</a></h2>
<p>As in <span id="id4">[<a class="reference internal" href="#id8" title="Peter C Young. Recursive estimation and time-series analysis: An introduction for the student and practitioner. Springer Science &amp; Business Media, 2011.">You11</a>]</span> (Chapter 4.4, moving body example) we implement the linear Kalman filter to estimate a single state variable over time.</p>
<p><strong>TODO</strong> Reference 1D kalman filter implementation code</p>
<p>As Young points out, there is a relationship between the filtering problem and regression. We can transform a regression problem into the filtering problem, then apply Kalman Filter.</p>
</section>
<section id="demonstration-on-temperature-data">
<h2>Demonstration on temperature data<a class="headerlink" href="#demonstration-on-temperature-data" title="Permalink to this heading">#</a></h2>
<p>To demonstrate this, take the following dataset from NASA <span id="id5">[<a class="reference internal" href="#id10" title="Global land-ocean temperature index. https://data.giss.nasa.gov/gistemp/graphs/graph_data/Global_Mean_Estimates_based_on_Land_and_Ocean_Data/graph.txt. Accessed: 2023-08-10.">nas</a>]</span>, which depicts the annual global average temperature as compared to a baseline temperature (the average temperature over the period of 1951 to 1980):</p>
<figure class="align-default" id="global-temp-fig" style="width: 400px">
<img alt="_images/b075bbeef2f87081467c4cb90ce21b9e32645938fccd50b3cd5abf4551dd50e7.png" src="_images/b075bbeef2f87081467c4cb90ce21b9e32645938fccd50b3cd5abf4551dd50e7.png" />
</figure>
<p>There is clearly an upward trend, but the data is noisy - from one year to the next the annual temperature average may go up or down. Furthermore, the upward trend appears nonlinear. How can we determine the trend from the noise?</p>
<p>We may transform this into filtering problem in a few ways:</p>
<ol class="arabic simple">
<li><p>Imagine the temperature is a noisy process and we have perfect measurements.</p></li>
<li><p>Imagine the temperature is fully deterministic process and we have noisy measurements.</p></li>
<li><p>Imagine the both the temperature process and our measurements have noise.</p></li>
</ol>
<p>Then our kalman filter estimate will be a regression of this temperature data.</p>
<p><strong>TODO</strong> Which of the above approaches do I demonstrate.</p>
<p><strong>TODO</strong> Insert figure of the global temperature anomalies</p>
<p><strong>TODO</strong> Discuss how a linear filter can be applied to this nonlinear problem.</p>
<section id="a-linear-kalman-filter-applied-to-non-linear-data">
<h3>A linear kalman filter applied to non-linear data<a class="headerlink" href="#a-linear-kalman-filter-applied-to-non-linear-data" title="Permalink to this heading">#</a></h3>
<p>Why was our linear-process-model Kalman Filter able to produce a non-linear regression? Even though we defined a constant “zero-velocity” process for our temperature, since we conceptualize the process as stochastic with some non-zero variance, the measurements can pull the trend upwards.</p>
<p><strong>TODO</strong> Show how tuning the Q and R values can make the filter less able to respond to the measurements.</p>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="code">
<h1>CODE<a class="headerlink" href="#code" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">collections</span> <span class="k">as</span> <span class="n">mc</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">from</span> <span class="nn">myst_nb</span> <span class="kn">import</span> <span class="n">glue</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="n">reload</span><span class="p">(</span><span class="n">utils</span><span class="p">)</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># TODO I don&#39;t think this is the correct way to seed</span>

<span class="kn">from</span> <span class="nn">IPython.core.debugger</span> <span class="kn">import</span> <span class="n">set_trace</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="global-temp-anomaly-data">
<h1>Global Temp Anomaly Data<a class="headerlink" href="#global-temp-anomaly-data" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;temp_anomalies.csv&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">no_smoothing</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#plt.show()</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;global_temp_data&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b075bbeef2f87081467c4cb90ce21b9e32645938fccd50b3cd5abf4551dd50e7.png" src="_images/b075bbeef2f87081467c4cb90ce21b9e32645938fccd50b3cd5abf4551dd50e7.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Named tuples to represent gaussian distributions</span>
<span class="n">Gauss</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Gauss&#39;</span><span class="p">,</span> <span class="s1">&#39;mean var&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="bayesian-style-implementation">
<h1>Bayesian Style Implementation<a class="headerlink" href="#bayesian-style-implementation" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_var</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="n">sensor_var</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1"># Measurements</span>
<span class="n">zs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">no_smoothing</span>

<span class="c1"># Initialize system and filter state</span>
<span class="c1"># Prior</span>
<span class="n">x_hat</span> <span class="o">=</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># Initialize estimate to first measurement value</span>

<span class="n">x_hats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">x_hat_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)):</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="c1"># Prediction step - via process model</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">Gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pred_var</span><span class="p">)</span>
    <span class="n">prior</span> <span class="o">=</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">x_hat</span><span class="o">.</span><span class="n">mean</span> <span class="o">+</span> <span class="n">dx</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">x_hat</span><span class="o">.</span><span class="n">var</span> <span class="o">+</span> <span class="n">dx</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
    
    <span class="c1"># Update (correct the prediction - from prior to posterior)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">sensor_var</span><span class="p">)</span> <span class="c1"># Likelihood of measurement</span>
    <span class="n">post_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">var</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">mean</span> <span class="o">+</span> <span class="n">l</span><span class="o">.</span><span class="n">var</span> <span class="o">*</span> <span class="n">prior</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">var</span> <span class="o">+</span> <span class="n">l</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
    <span class="n">post_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">var</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">var</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">var</span> <span class="o">+</span> <span class="n">l</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
    <span class="n">x_hat</span> <span class="o">=</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">post_mean</span><span class="p">,</span> <span class="n">post_var</span><span class="p">)</span>
    <span class="n">x_hats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_hat</span><span class="o">.</span><span class="n">mean</span>
    <span class="n">x_hat_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_hat</span><span class="o">.</span><span class="n">var</span>
    
    <span class="c1"># Posterior becomes next iterations prior</span>
    <span class="n">prior</span> <span class="o">=</span> <span class="n">x_hat</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">no_smoothing</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$z$ measurements&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">x_hats</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$ estimates&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">x_hats</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_hat_vars</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\sigma_{\hat</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">x_hats</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_hat_vars</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Kalman Filter. sensor_var:</span><span class="si">{</span><span class="n">sensor_var</span><span class="si">}</span><span class="s1">. pred_var:</span><span class="si">{</span><span class="n">pred_var</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimate variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">x_hat_vars</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/eebe2556381fc4a2a0c2e6f47f2ab9651e9a5a84ee5ed9cb08e886b609e3b2e1.png" src="_images/eebe2556381fc4a2a0c2e6f47f2ab9651e9a5a84ee5ed9cb08e886b609e3b2e1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimate variance
</pre></div>
</div>
<img alt="_images/2c4226715e11e25b1eec78f651697c73f985c06cd402ece6884b38ee49875ca3.png" src="_images/2c4226715e11e25b1eec78f651697c73f985c06cd402ece6884b38ee49875ca3.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="rewriting-in-standard-notation">
<h1>Rewriting in Standard notation<a class="headerlink" href="#rewriting-in-standard-notation" title="Permalink to this heading">#</a></h1>
<p>Reimplementing the above using the standard notation:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(P\)</span>: Prior (prediction) variance</p></li>
<li><p><span class="math notranslate nohighlight">\(R\)</span>: Measurement noise variance</p></li>
<li><p><span class="math notranslate nohighlight">\(Q\)</span>: Process noise variance</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO Docs</span>
<span class="k">def</span> <span class="nf">kalman_1d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">P_0</span><span class="p">,</span> <span class="n">x_0</span><span class="p">):</span>
    <span class="c1"># Initialize system and filter state</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">Ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
    <span class="c1"># Prior</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P_0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_0</span>

    <span class="c1"># TODO: Should we exclude prediction calculation for first iteration?</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)):</span>
        <span class="c1"># PREDICT STEP - Process model update</span>
        <span class="c1"># dx = Gauss(0, Q)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">0</span> <span class="c1"># Prediction mean</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">+</span> <span class="n">Q</span> <span class="c1"># Prediction var</span>

        <span class="c1"># UPDATE STEP (if there is a measurement at this timestep)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zs</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span>

            <span class="c1"># Kalman Gain</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">P</span> <span class="o">/</span> <span class="p">(</span><span class="n">P</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span>

            <span class="c1"># Posterior: Use kalman gain to scale the residual between prediction and measurement</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">K</span> <span class="o">*</span> <span class="n">resid</span>
            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">K</span><span class="p">)</span> <span class="o">*</span> <span class="n">P</span>

        <span class="c1"># Save results</span>
        <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">Ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
        
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span>

<span class="c1"># Configure and run the filter</span>
<span class="n">R</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="c1"># Measurement variance</span>
<span class="n">Q</span> <span class="o">=</span> <span class="mf">0.03</span> <span class="c1"># Process noise variance</span>
<span class="n">zs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">no_smoothing</span> <span class="c1"># Measurements</span>
<span class="n">P_0</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">x_0</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_1d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">P_0</span><span class="p">,</span> <span class="n">x_0</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$z$ measurements&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$ estimates&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">lowess_5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;lowess(5)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\sigma_{\hat</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fb1024c077bb19b8ff7f5a5ad5ee021e81b9f101f4801ce0c08a383e7545812f.png" src="_images/fb1024c077bb19b8ff7f5a5ad5ee021e81b9f101f4801ce0c08a383e7545812f.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="exploring-how-the-kalman-filter-behaves-with-data-gaps">
<h1>Exploring how the kalman filter behaves with data gaps<a class="headerlink" href="#exploring-how-the-kalman-filter-behaves-with-data-gaps" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="c1"># Measurement variance</span>
<span class="n">Q</span> <span class="o">=</span> <span class="mf">0.03</span> <span class="c1"># Process noise variance</span>
<span class="n">zs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">no_smoothing</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># Measurements</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
    <span class="c1"># Define an data gap interval</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1"># Years beyond 1880</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">20</span><span class="o">*</span><span class="n">i</span>
    <span class="n">gap_zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
    <span class="n">gap_zs</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    
    <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_1d</span><span class="p">(</span><span class="n">gap_zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">P_0</span><span class="p">,</span> <span class="n">x_0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">gap_zs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$z$ measurements&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$ estimates&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\sigma_{\hat</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xs</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a155d48796af2c5624484704990a5ef668fbdd92f71d14329431d7b1ba802b94.png" src="_images/a155d48796af2c5624484704990a5ef668fbdd92f71d14329431d7b1ba802b94.png" />
<img alt="_images/773652b65f2b0878bf34af79c47875aaa76434eaa874ca2a08ecac119d67a921.png" src="_images/773652b65f2b0878bf34af79c47875aaa76434eaa874ca2a08ecac119d67a921.png" />
<img alt="_images/d1456a1e44fde6da92903b07751853cdc669cf01ad1465535e21f04d17b77fe0.png" src="_images/d1456a1e44fde6da92903b07751853cdc669cf01ad1465535e21f04d17b77fe0.png" />
</div>
</div>
<p><strong>TODO</strong> The above gaps might look better if the process model assumed a constant velocity of the last velocity seen?</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="exploring-the-parameter-space-of-q-x-r">
<h1>Exploring the parameter space of <span class="math notranslate nohighlight">\(Q\)</span> x <span class="math notranslate nohighlight">\(R\)</span><a class="headerlink" href="#exploring-the-parameter-space-of-q-x-r" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_R_vals</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">R_min</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">9</span>
<span class="n">R_max</span> <span class="o">=</span> <span class="mf">4.0</span>
<span class="k">for</span> <span class="n">Q</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">):</span> <span class="c1"># Process noise variance values</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">num_R_vals</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># TODO set figure sizes</span>
    <span class="n">R_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">R_min</span><span class="p">,</span> <span class="n">R_max</span><span class="p">,</span> <span class="p">(</span><span class="n">R_max</span><span class="o">-</span><span class="n">R_min</span><span class="p">)</span><span class="o">/</span><span class="n">num_R_vals</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">R_vals</span><span class="p">):</span> <span class="c1"># Measurement noise variance values</span>
        <span class="n">P_0</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">x_0</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_1d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">P_0</span><span class="p">,</span> <span class="n">x_0</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$z$ measurements&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$ estimates&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\sigma_{\hat</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">xs</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ps</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Q:</span><span class="si">{</span><span class="n">Q</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1">. R:</span><span class="si">{</span><span class="n">R</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ecd01280441e2ad93408764d58b6828d7a5c800024fb49e9028093b2164ca8b1.png" src="_images/ecd01280441e2ad93408764d58b6828d7a5c800024fb49e9028093b2164ca8b1.png" />
<img alt="_images/df6b32d5fd378d2fe6dc202ad5940ff808756444f97b3acb5acf772d57b047d2.png" src="_images/df6b32d5fd378d2fe6dc202ad5940ff808756444f97b3acb5acf772d57b047d2.png" />
<img alt="_images/e8365070583344c8b0bd91c2c24b3c66b3e01425340996a933feca0da3524ff5.png" src="_images/e8365070583344c8b0bd91c2c24b3c66b3e01425340996a933feca0da3524ff5.png" />
<img alt="_images/1864e0d8f6305b5566abc3834980f3e3f98c41c40ff41142f579808b181b34b7.png" src="_images/1864e0d8f6305b5566abc3834980f3e3f98c41c40ff41142f579808b181b34b7.png" />
<img alt="_images/e68ea68659a064fafd8f75214e67f429f3186faff31abddbfaec3a2385f9c387.png" src="_images/e68ea68659a064fafd8f75214e67f429f3186faff31abddbfaec3a2385f9c387.png" />
<img alt="_images/8db16427650a36726eef0dc39f88d2125de9d09066f922c69be63fb6f11ddf33.png" src="_images/8db16427650a36726eef0dc39f88d2125de9d09066f922c69be63fb6f11ddf33.png" />
<img alt="_images/1dd2f0a08069f8f1466f5388f9fd7335414fb21631001d2ad952728e4d119ffc.png" src="_images/1dd2f0a08069f8f1466f5388f9fd7335414fb21631001d2ad952728e4d119ffc.png" />
<img alt="_images/d6015a6d6f11f2e8279473605a4b5c2601a443c30fc1448c73420bfa0a431966.png" src="_images/d6015a6d6f11f2e8279473605a4b5c2601a443c30fc1448c73420bfa0a431966.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="d-kalman-for-process-with-constant-acceleration">
<h1>2D Kalman for Process With Constant Acceleration<a class="headerlink" href="#d-kalman-for-process-with-constant-acceleration" title="Permalink to this heading">#</a></h1>
<p>First lets create our deterministic process model</p>
<p>State: <span class="math notranslate nohighlight">\(\vec{x} = \begin{bmatrix} x &amp; \dot{x} &amp; \ddot{x} &amp; y &amp; \dot{y} &amp; \ddot{y}\end{bmatrix}^T\)</span></p>
<p>Constant acceleration: <span class="math notranslate nohighlight">\(\begin{bmatrix} \ddot{x} &amp;  \ddot{y} \end{bmatrix}^T = \begin{bmatrix} 0 &amp;  -9.81 \end{bmatrix}^T \)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulation config</span>

<span class="c1"># Timestep</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># Number of seconds of simulation</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">dt</span>
<span class="k">assert</span> <span class="n">N</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulating </span><span class="si">{</span><span class="n">T</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1"> seconds. </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s1"> timesteps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simulating 5.00 seconds. 50 timesteps
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial position</span>
<span class="n">x_0</span><span class="p">,</span> <span class="n">y_0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># Initial velocity</span>
<span class="n">vx_0</span><span class="p">,</span> <span class="n">vy_0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

<span class="c1"># Constant acceleration</span>
<span class="n">ax_0</span><span class="p">,</span> <span class="n">ay_0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">]</span>

<span class="c1"># Initial state</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># State dimensionality</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_0</span><span class="p">,</span> <span class="n">vx_0</span><span class="p">,</span> <span class="n">ax_0</span><span class="p">,</span> <span class="n">y_0</span><span class="p">,</span> <span class="n">vy_0</span><span class="p">,</span> <span class="n">ay_0</span><span class="p">])</span>

<span class="c1"># Transition matrix</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">],</span> 
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
<span class="p">])</span>

<span class="c1"># Results matrix. Each row is the state for one timestep</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x0</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">F</span> <span class="o">@</span> <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3dd9ab20e3595c1619d3b140c69d137960cfc5611d99731eb3a2aec8bf708357.png" src="_images/3dd9ab20e3595c1619d3b140c69d137960cfc5611d99731eb3a2aec8bf708357.png" />
</div>
</div>
<p>Now lets add <strong>noise</strong> to the process:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Approximate Q as only variance for the acceleration components ax and ay.</span>
<span class="n">accel_var</span> <span class="o">=</span> <span class="mf">0.015</span>
<span class="n">Q_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">accel_var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">accel_var</span><span class="p">],</span>
<span class="p">])</span>

<span class="c1"># Results matrix. Each row is the state for one timestep</span>
<span class="n">true_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">true_xs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x0</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="c1"># Process noise - only affects acceleration</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">Q_true</span><span class="p">)</span>
    
    <span class="n">true_xs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">F</span> <span class="o">@</span> <span class="n">true_xs</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">eta</span>
    
    <span class="c1"># PROBLEM: This is accumulating the acceleration noise over each step.</span>
    <span class="c1"># I want it to vary around the constant acceleration value.</span>
    <span class="c1"># Should acceleration at the next step be a0 + eta?</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;X-Y Track Of Object&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Estimated Acceleration Of Object&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ed937e14588dbe5c441fb434307326e27b905c4f96334262fb4d6e8d8e1b1344.png" src="_images/ed937e14588dbe5c441fb434307326e27b905c4f96334262fb4d6e8d8e1b1344.png" />
<img alt="_images/f50026dcf882a125dadcda41a01124a1b5396efe004dd436164220dc87ee8fb9.png" src="_images/f50026dcf882a125dadcda41a01124a1b5396efe004dd436164220dc87ee8fb9.png" />
</div>
</div>
<p><strong>TODO/Question</strong>: Notice the above estimated acceleration state is a brownian walk. i.e. cumulative. I’m unsure if that’s correct. Intuitively I thought it would bounce around a mean of <span class="math notranslate nohighlight">\(\vec{a}= [0, -9.8]^T\)</span>, but over a long time this would result in acceleration that is pretty far off from that of gravity. That can’t be the right model… can it?</p>
<ul class="simple">
<li><p>Maybe it can. The the Labbe <a class="reference external" href="https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python/blob/master/08-Designing-Kalman-Filters.ipynb">Designing Kalman Filters</a> section discussing filter orders, he does exactly that in his analogous 2nd order filter.</p></li>
<li><p>TODO: See <a class="reference external" href="https://www.kalmanfilter.net/multiExamples.html">kalman filter tutorial example</a>, in which the acceleration is moved into the control term, and only position and velocity are tracked in state (first order filter?).</p></li>
</ul>
<p>Also keep in mind:</p>
<ul class="simple">
<li><p>The difference between the actual process noise (eg what we use to create the synthetic process series), and the process noise we tell the Kalman filter (which is more a degree of weight to give the predictions vs measurements).</p></li>
<li><p>The true velocity and acceleration components of the synthesized track are values of the hidden variables (assuming we only have a position sensor)</p></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="multidimensional-linear-kalman-filter">
<h1>Multidimensional linear kalman filter<a class="headerlink" href="#multidimensional-linear-kalman-filter" title="Permalink to this heading">#</a></h1>
<p>Estimate covariance <span class="math notranslate nohighlight">\(P\)</span>:</p>
<p><span class="math notranslate nohighlight">\(
P = \begin{bmatrix}
\sigma_{x}^2 &amp; \sigma_{x,\dot{x}}^2 &amp; \sigma_{x,\ddot{x}}^2 &amp; \sigma_{x,y}^2 &amp; \sigma_{x,\dot{y}}^2 &amp; \sigma_{x,\ddot{y}}^2  \\
\sigma_{\dot{x},x}^2 &amp; \sigma_{\dot{x}}^2 &amp; \sigma_{\dot{x},\ddot{x}}^2 &amp; \sigma_{\dot{x},y}^2 &amp; \sigma_{\dot{x},\dot{y}}^2 &amp; \sigma_{\dot{x},\ddot{y}}^2  \\
\sigma_{\ddot{x},x}^2 &amp; \sigma_{\ddot{x},\dot{x}}^2 &amp; \sigma_{\ddot{x}}^2 &amp; \sigma_{\ddot{x},y}^2 &amp; \sigma_{\ddot{x},\dot{y}}^2 &amp; \sigma_{\ddot{x},\ddot{y}}^2  \\
\sigma_{y,x}^2 &amp; \sigma_{y,\dot{x}}^2 &amp; \sigma_{y,\ddot{x}}^2 &amp; \sigma_{y}^2 &amp; \sigma_{y,\dot{y}}^2 &amp; \sigma_{y,\ddot{y}}^2  \\
\sigma_{\dot{y},x}^2 &amp; \sigma_{\dot{y},\dot{x}}^2 &amp; \sigma_{\dot{y},\ddot{x}}^2 &amp; \sigma_{\dot{y},y}^2 &amp; \sigma_{\dot{y}}^2 &amp; \sigma_{\dot{y},\ddot{y}}^2  \\
\sigma_{\ddot{y},x}^2 &amp; \sigma_{\ddot{y},\dot{x}}^2 &amp; \sigma_{\ddot{y},\ddot{x}}^2 &amp; \sigma_{\ddot{y},y}^2 &amp; \sigma_{\ddot{y},\dot{y}}^2 &amp; \sigma_{\ddot{y}}^2 
\end{bmatrix}
\)</span></p>
<section id="synthesizing-measurements">
<h2>Synthesizing measurements<a class="headerlink" href="#synthesizing-measurements" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Synthesize measurements by adding random noise to the true position series</span>
<span class="n">z_var</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="c1"># Measurement (position) noise covariance matrix (independent bivariate normal)</span>
<span class="n">R_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="n">z_var</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_var</span><span class="p">],</span>
<span class="p">])</span>
<span class="n">zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">zs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_xs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># x positions</span>
<span class="n">zs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_xs</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="c1"># y positions</span>

<span class="n">zs</span> <span class="o">=</span> <span class="n">zs</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">R_true</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">zs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{z}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Synthesized measurement noise&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e544b18331feb1b1e239eddb8317c2c88b1c2cdddc5cb740071a439a22e1e86b.png" src="_images/e544b18331feb1b1e239eddb8317c2c88b1c2cdddc5cb740071a439a22e1e86b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Matrix H converts state vectors into measurement space</span>
<span class="c1"># In this model, that means grabbing the position values</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">])</span>

<span class="k">def</span> <span class="nf">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
    <span class="c1"># Store filter estimates (means and variances)</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">Ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
    <span class="c1"># Initial estimate</span>
    <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x_0</span>
    <span class="n">Ps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_0</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span>

    <span class="c1"># TODO: Should we exclude prediction calculation for first iteration?</span>
    <span class="c1"># But we still want to do the correction for the first iteration, right?</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="c1"># 1) PREDICT</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">F</span> <span class="o">@</span> <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">F</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">F</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>

        <span class="c1"># 2) UPDATE</span>
        <span class="c1"># TODO: Currently using Labbe notation. Switch to Young?</span>

        <span class="c1"># Calculate system uncertainty</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">H</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span>

        <span class="c1"># Calculate kalman gain</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

        <span class="c1"># Calculate residual: Difference between prediction an measurement</span>
        <span class="c1"># (In measurement space)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">H</span> <span class="o">@</span> <span class="n">prior</span>

        <span class="c1"># Caculate posterior state (corrected estimate and covar)</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">y</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">P</span>

        <span class="c1"># Save</span>
        <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">post</span>
        <span class="n">Ps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
        
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span>

<span class="c1"># TODO: Known bug. When R and Q are zero matrices, the value of S&#39;s elements get tiny (floating</span>
<span class="c1"># point errors representing zero), which leads inv(S) to produce a matrix of nans. This produces</span>
<span class="c1"># nan estimates from that iteration onwards. Not sure how to avoid, but a workaround is to not pass</span>
<span class="c1"># in Q and R made of all zeros.</span>

<span class="c1"># Initialize filter state</span>
<span class="c1"># Guess the position somewhat accurately, leave the velocity and acceleration state guesses as 0</span>
<span class="n">x_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">P_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span> <span class="c1"># Start with very low confidence in predictions</span>

<span class="c1"># Assume we can configure the system&#39;s process and measurement noise params correctly</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">Q_true</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">R_true</span>

<span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">)</span>
    
<span class="c1"># Extract covariances for position, velocity, and acceleration</span>
<span class="n">pos_vars</span><span class="p">,</span> <span class="n">vel_vars</span><span class="p">,</span> <span class="n">acc_vars</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_covar_series</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>
    
<span class="c1"># Plot track, measurements, and estimate for position</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">zs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{z}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Kalman position estimate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot positional variance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">pos_vars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;x variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">pos_vars</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;y variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Position estimate variances over time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma^2$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot positional estimates with 3sigma ellipses</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> 
<span class="n">axes</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
<span class="c1"># Plot prediction 3-sigma elipses</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vel_vars</span><span class="p">)):</span>
    <span class="n">pos_var</span> <span class="o">=</span> <span class="n">pos_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]])</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">plot_covar_ellipse</span><span class="p">(</span><span class="n">pos_var</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">zs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{z}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Position estimate $3-\sigma$ ellipses&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot velocity estimates</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> 
<span class="n">axes</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
<span class="c1"># Plot prediction 3-sigma elipses</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vel_vars</span><span class="p">)):</span>
    <span class="n">vel_var</span> <span class="o">=</span> <span class="n">vel_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">plot_covar_ellipse</span><span class="p">(</span><span class="n">vel_var</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="c1"># Plot track and estimates</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\dot</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat{\dot</span><span class="si">{x}</span><span class="s1">}$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Kalman velocity estimates and $3\sigma$ Ellipses. $v_x$ vs $v_y$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X velocity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y velocity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot velocity variances</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">vel_vars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\dot</span><span class="si">{x}</span><span class="s1">$ variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">vel_vars</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\dot</span><span class="si">{y}</span><span class="s1">$ variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Velocity estimate variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot acceleratioin variances</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">acc_vars</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\ddot</span><span class="si">{x}</span><span class="s1">$ variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">acc_vars</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\ddot</span><span class="si">{y}</span><span class="s1">$ variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Acceleration estimate variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># TODO could plot x and y pos, vel, and acc as functions of t.</span>
<span class="c1"># TODO Plot x(t) and vel_x(t) slopes overlaid</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/22c321e8709faf1d94da41d285bed89d91cb2c446a2665d3ea026a0b2405920c.png" src="_images/22c321e8709faf1d94da41d285bed89d91cb2c446a2665d3ea026a0b2405920c.png" />
<img alt="_images/8592d56b2162a1ddc70ec1e05652aa87708fcbbfcf25d6e820249ba7f8409e52.png" src="_images/8592d56b2162a1ddc70ec1e05652aa87708fcbbfcf25d6e820249ba7f8409e52.png" />
<img alt="_images/90edf08c10d002b8339c844fe6cc5e949358ada3b712dcb9ebed83ca489cb333.png" src="_images/90edf08c10d002b8339c844fe6cc5e949358ada3b712dcb9ebed83ca489cb333.png" />
<img alt="_images/b16e649e77ba120f0a488b02914de23ae0a5406a1cb3a8c22a228ec908236781.png" src="_images/b16e649e77ba120f0a488b02914de23ae0a5406a1cb3a8c22a228ec908236781.png" />
<img alt="_images/009d196b00b066c73faad218c90cb83b5a6b2e4c53b9807ad960d5770357e66e.png" src="_images/009d196b00b066c73faad218c90cb83b5a6b2e4c53b9807ad960d5770357e66e.png" />
<img alt="_images/155b94a263a4b540b0ed6b23049d4f1d52035f8c78a90e8cfec9973bae39f956.png" src="_images/155b94a263a4b540b0ed6b23049d4f1d52035f8c78a90e8cfec9973bae39f956.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="do-the-true-positions-vec-x-k-fall-within-the-hat-x-k-estimates-3-sigma-confidence-ellipses">
<h1>Do the true positions <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> fall within the <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> estimates’ <span class="math notranslate nohighlight">\(3\sigma\)</span> confidence ellipses?<a class="headerlink" href="#do-the-true-positions-vec-x-k-fall-within-the-hat-x-k-estimates-3-sigma-confidence-ellipses" title="Permalink to this heading">#</a></h1>
<p><strong>TODO</strong> Organization: Move this into the section discussing accuracy of the filter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Return a boolean array, where each element encodes whether the k-th true</span>
<span class="c1"># state is within n-std confidence ellipse of the k-th estimate.</span>
<span class="c1"># Only works for 2D state</span>
<span class="k">def</span> <span class="nf">within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args: </span>
<span class="sd">            xs: State estimate array</span>
<span class="sd">            true_xs: True state array</span>
<span class="sd">            Ps: Estimate covariance array</span>
<span class="sd">            n_std: Number of standard deviations defining the covar ellipse size</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">Ps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ellipse_contains</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">Ps</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">n_std</span><span class="o">=</span><span class="n">n_std</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Visualize the accuracy of 2D state estimates as whether their 2x2 covariance ellipses</span>
<span class="c1"># contain the true state values.</span>
<span class="k">def</span> <span class="nf">plot_estimate_covar_accuracy</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)):</span>
    <span class="c1"># Plot positional estimates with 3sigma ellipses</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span> 
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 

    <span class="c1"># Plot estimated and true state</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Plot prediction 3-sigma elipses</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="c1">#mu = np.array([xs[k,0], xs[k,3]])</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">plot_covar_ellipse</span><span class="p">(</span><span class="n">Ps</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

    <span class="c1"># Calculate whether k-th true value falls within k-th estimates ellipse</span>
    <span class="n">accurate_ellipses</span> <span class="o">=</span> <span class="n">within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="c1"># TODO separate visualization logic into a function</span>

    <span class="c1"># Plot line segments connecting each estimate to its true value for time k</span>
    <span class="n">line_segs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">line_segs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>

    <span class="c1"># Color line segments based on the estimate accuracy</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">accurate_ellipses</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">LineCollection</span><span class="p">(</span><span class="n">line_segs</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$|\vec</span><span class="si">{x}</span><span class="s1">-\hat</span><span class="si">{x}</span><span class="s1">|$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Estimate Covariance Accuracy&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Percent of estimate covar ellipse containing true state: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">accurate_ellipses</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">N</span><span class="si">:</span><span class="s1">.02f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    
<span class="c1"># Demonstrate with x-y position state estimates</span>
<span class="n">x_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">P_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span> <span class="c1"># Start with very low confidence in predictions</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">Q_true</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">R_true</span>

<span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">)</span>
<span class="n">xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span>
<span class="n">Ps_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_covar_series</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>

<span class="n">plot_estimate_covar_accuracy</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> 
                             <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x position&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;y position&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R:</span><span class="se">\n</span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="se">\n</span><span class="s1">Q:</span><span class="se">\n</span><span class="si">{</span><span class="n">Q</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7486e8df3b2c28e3986a498fe77386766808ec748a9df337792120ec14c10feb.png" src="_images/7486e8df3b2c28e3986a498fe77386766808ec748a9df337792120ec14c10feb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
R:
[[1.2 0. ]
 [0.  1.2]]
Q:
[[0.    0.    0.    0.    0.    0.   ]
 [0.    0.    0.    0.    0.    0.   ]
 [0.    0.    0.015 0.    0.    0.   ]
 [0.    0.    0.    0.    0.    0.   ]
 [0.    0.    0.    0.    0.    0.   ]
 [0.    0.    0.    0.    0.    0.015]]
</pre></div>
</div>
</div>
</div>
<section id="exploring-covariance-of-position-with-velocity">
<h2>Exploring covariance of position with velocity<a class="headerlink" href="#exploring-covariance-of-position-with-velocity" title="Permalink to this heading">#</a></h2>
<p>TODO: Graph <span class="math notranslate nohighlight">\(\sigma_{x,\dot{x}}^2\)</span> and <span class="math notranslate nohighlight">\(\sigma_{y,\dot{y}}^2\)</span> for first few timesteps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract pos-vel covariance in the x dimension</span>
<span class="n">pos_vel_x_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ps</span><span class="p">)):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">pos_vel_x_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],[</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]])</span>

<span class="c1"># Plot</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> 
<span class="n">axes</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
<span class="c1"># Plot prediction 3-sigma covariance elipses</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_vel_x_vars</span><span class="p">)):</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">pos_vel_x_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">plot_covar_ellipse</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">true_xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$[x,\dot</span><span class="si">{x}</span><span class="s1">]^T$ true&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$[x,\dot</span><span class="si">{x}</span><span class="s1">]^T$ estimated&#39;</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#plt.plot(zs[:,0], zs[:,1], label=r&#39;$\vec{z}$&#39;, marker=&#39;o&#39;, linestyle=&#39;none&#39;, markersize=2)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma_{x,\dot</span><span class="si">{x}</span><span class="s1">}^2$: x position-velocity covariance $3\sigma$ ellipses&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;x velocity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c40f5d6909e45e6d833be6ca51a775fcdc71e1f91402da28efdf255d91c91461.png" src="_images/c40f5d6909e45e6d833be6ca51a775fcdc71e1f91402da28efdf255d91c91461.png" />
</div>
</div>
<p>Notes: Above displays how the filter learns the covariance between position and the hidden variable velocity over time. It starts with prediction uncertainty as a wide variance fully uncorrelated (circular) ellipse, then converges over time to the way it looks in the end: with a positive covariance between position and velocity.</p>
<p><strong>TODO</strong> We could expand this to show <span class="math notranslate nohighlight">\(\sigma_{y,\dot{y}}^2\)</span>, <span class="math notranslate nohighlight">\(\sigma_{\dot{x},\ddot{x}}^2\)</span>, etc. Doubt if it will illustrate much more beyond the above diagram though.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="quantifying-the-accuracy-of-the-kalman-filter-s-predictions">
<h1>Quantifying the Accuracy of the Kalman Filter’s Predictions<a class="headerlink" href="#quantifying-the-accuracy-of-the-kalman-filter-s-predictions" title="Permalink to this heading">#</a></h1>
<p>Methods of quantifying:</p>
<p><strong>TODO</strong> explore:</p>
<ul class="simple">
<li><p>Develop an intuitive custom score: <strong>Confirm what percent of true values are within the 3-sigma ellipses of the estimates.</strong></p></li>
</ul>
<section id="nees">
<h2>NEES<a class="headerlink" href="#nees" title="Permalink to this heading">#</a></h2>
<p>Sources</p>
<ul class="simple">
<li><p><a class="reference external" href="https://kalman-filter.com/normalized-estimation-error-squared/">kalman-filter.com</a></p></li>
<li><p><a class="reference external" href="https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python/blob/master/08-Designing-Kalman-Filters.ipynb">Labbe</a></p></li>
</ul>
<p>Error vectors: <span class="math notranslate nohighlight">\(\tilde{x}(k) = \vec{x}(k) - \hat{x}(k)\)</span></p>
<p>NEES (scalar values): <span class="math notranslate nohighlight">\(\epsilon(k) = \tilde{x}(k)^T \textbf{P}^{-1} \tilde{x}(k)\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xs_pos</span><span class="p">,</span> <span class="n">xs_vel</span><span class="p">,</span> <span class="n">xs_acc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">true_xs_vel</span><span class="p">,</span> <span class="n">true_xs_acc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span>

<span class="c1">## COMPLETE state vector NEES </span>
<span class="n">x_tilde</span> <span class="o">=</span> <span class="n">true_xs</span> <span class="o">-</span> <span class="n">xs</span>
<span class="n">nees_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> <span class="c1"># TODO can we vectorize this loop?</span>
    <span class="n">nees_ts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Ps</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">@</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">nees_ts</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Complete state NEES&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">,\dot</span><span class="si">{x}</span><span class="s1">,\ddot</span><span class="si">{x}</span><span class="s1">$  NEES&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># A &#39;good&#39; NEES score is: the average value of the NEES timeseries is less than the dimension of the state vector</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Complete NEES score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Complete state NEES distribution compared to chi-2</span>
<span class="n">domain</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)))</span>
<span class="c1"># Set the number of histogram bins so each has width unity</span>
<span class="n">num_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">h_vals</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h_vals</span><span class="p">)</span>
<span class="n">domain_ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">domain_ls</span><span class="p">,</span> <span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">domain_ls</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\chi^2_6$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\epsilon(k) values$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># POSITION NEES</span>
<span class="c1"># The difference between the estimate and the true position state</span>
<span class="n">x_tilde</span> <span class="o">=</span> <span class="n">true_xs_pos</span> <span class="o">-</span> <span class="n">xs_pos</span>
<span class="n">nees_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> <span class="c1"># TODO can we vectorize these NEES calculation loops?</span>
    <span class="n">nees_ts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">pos_vars</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">@</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">nees_ts</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Position state NEES&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\vec</span><span class="si">{x}</span><span class="s1">$  NEES&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Position NEES score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Position NEES distribution compared to chi-2</span>
<span class="n">domain</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)))</span>
<span class="c1"># Set the number of histogram bins so each has width unity</span>
<span class="n">num_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">h_vals</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">h_vals</span><span class="p">)</span>
<span class="n">domain_ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">domain_ls</span><span class="p">,</span> <span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">domain_ls</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\chi^2_2$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\epsilon(k) values$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># VELOCITY NEES</span>
<span class="n">x_tilde</span> <span class="o">=</span> <span class="n">true_xs_vel</span> <span class="o">-</span> <span class="n">xs_vel</span>
<span class="n">nees_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">nees_ts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">vel_vars</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">@</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">nees_ts</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Velocity state NEES&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\dot</span><span class="si">{x}</span><span class="s1">$  NEES&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Velocity NEES score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># ACCELERATION NEES</span>
<span class="n">x_tilde</span> <span class="o">=</span> <span class="n">true_xs_acc</span> <span class="o">-</span> <span class="n">xs_acc</span>
<span class="n">nees_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> <span class="c1"># TODO can we vectorize this loop?</span>
    <span class="n">nees_ts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">acc_vars</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">@</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">nees_ts</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Acceleration state NEES&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ddot</span><span class="si">{x}</span><span class="s1">$  NEES&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acceleration NEES score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nees_ts</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8483d184092d867001172d40c404737374c0d2b8f8a00295c6a7240370db89cb.png" src="_images/8483d184092d867001172d40c404737374c0d2b8f8a00295c6a7240370db89cb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Complete NEES score: 5.615083226038849
</pre></div>
</div>
<img alt="_images/fa9bccd498f93f02b7ba4163e9206ab206c8c2bd254f594bd56ac0c05a049333.png" src="_images/fa9bccd498f93f02b7ba4163e9206ab206c8c2bd254f594bd56ac0c05a049333.png" />
<img alt="_images/68a95794e0713956e7c4fb5f7b962937bf19599fbde32d57750cdec92768f3a7.png" src="_images/68a95794e0713956e7c4fb5f7b962937bf19599fbde32d57750cdec92768f3a7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Position NEES score: 1.8521419590449708
</pre></div>
</div>
<img alt="_images/9dddd78f23e023abe69a3fb6153e8ca291d39676e2e11129ef6c37c8e8446a0f.png" src="_images/9dddd78f23e023abe69a3fb6153e8ca291d39676e2e11129ef6c37c8e8446a0f.png" />
<img alt="_images/449e30fde8a57a6ed4d363f4a7b8e6d7ece4c0ffc4180540d25d08769c8d7227.png" src="_images/449e30fde8a57a6ed4d363f4a7b8e6d7ece4c0ffc4180540d25d08769c8d7227.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Velocity NEES score: 2.893379246281296
</pre></div>
</div>
<img alt="_images/6820c039752fd5ce58846797ce0e4b65dde2a3d3007408a7b5402a2dc14be46d.png" src="_images/6820c039752fd5ce58846797ce0e4b65dde2a3d3007408a7b5402a2dc14be46d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acceleration NEES score: 2.503600489582321
</pre></div>
</div>
</div>
</div>
<p>Above we have shown:</p>
<ul class="simple">
<li><p>The full state vector <span class="math notranslate nohighlight">\(\vec{x}\)</span> (as well as the split out position, velocity, and accelerate state 2-tuples) comply with the <span class="math notranslate nohighlight">\(\chi^2_k\)</span> distributions, and that the average value of the NEES series is less than the number of elements in the respective state vector.</p></li>
<li><p>The state vectors <span class="math notranslate nohighlight">\(\epsilon(k)\)</span> distributions are indeed <span class="math notranslate nohighlight">\(\chi^2_k\)</span>, verified by overlaying the actual NEES values histogram with the <span class="math notranslate nohighlight">\(\chi^2_k\)</span> pdfs.</p></li>
</ul>
<p><strong>QUESTIONS</strong>:</p>
<ul class="simple">
<li><p>I’ve shown the the NEES values are <span class="math notranslate nohighlight">\(\chi^2_k\)</span>-distributed, and therefor have the expected values of <span class="math notranslate nohighlight">\(k\)</span>. How does this related to Labbes informal assertion that as long as average NEES value is <span class="math notranslate nohighlight">\(\lt k\)</span> the filter is performing well? Why would it be anything other than equal to k?</p>
<ul>
<li><p>TODO: Read the paper recommended by labbe.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="exploring-residuals">
<h1>Exploring Residuals<a class="headerlink" href="#exploring-residuals" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># rs = true_xs - xs</span>
<span class="c1"># Note this function assumes the given ax is part of a multi subplot figure</span>
<span class="k">def</span> <span class="nf">plot_residuals</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">rs_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">rs_norms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">rs_norms</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residual norm (log scale)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>

<span class="c1"># Calculate and plot residuals for multiple (track, estimate) pairs on one figure</span>
<span class="k">def</span> <span class="nf">plot_all_residuals_2</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">estimates</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        tracks: List of true state timeseries</span>
<span class="sd">        estimates: List of estimated state timeseries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">track</span><span class="p">,</span> <span class="n">estimate</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">estimates</span><span class="p">):</span>
        <span class="n">xs_pos</span><span class="p">,</span> <span class="n">xs_vel</span><span class="p">,</span> <span class="n">xs_acc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">true_xs_vel</span><span class="p">,</span> <span class="n">true_xs_acc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">estimate</span><span class="p">)</span>

        <span class="c1"># Complete Residuals</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">track</span> <span class="o">-</span> <span class="n">estimate</span>
        <span class="n">plot_residuals</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Complete $\vec</span><span class="si">{x}</span><span class="s1">$ Residuals&#39;</span><span class="p">)</span>

        <span class="c1"># Position residuals</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">true_xs_pos</span> <span class="o">-</span> <span class="n">xs_pos</span>
        <span class="n">plot_residuals</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Position Residuals&#39;</span><span class="p">)</span>

        <span class="c1"># Velocity residuals</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">true_xs_vel</span> <span class="o">-</span> <span class="n">xs_vel</span>
        <span class="n">plot_residuals</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Velocity Residuals&#39;</span><span class="p">)</span>

        <span class="c1"># Velocity residuals</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">true_xs_acc</span> <span class="o">-</span> <span class="n">xs_acc</span>
        <span class="n">plot_residuals</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Acceleration Residuals&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_all_residuals_2</span><span class="p">([</span><span class="n">true_xs</span><span class="p">],</span> <span class="p">[</span><span class="n">xs</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TODO: Why doesn</span><span class="se">\&#39;</span><span class="s1">t position residual norm curve look like the others?&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3b169aecd127846e70d321c76c643aa0f91a9891ba1753894224c08375374464.png" src="_images/3b169aecd127846e70d321c76c643aa0f91a9891ba1753894224c08375374464.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TODO: Why doesn&#39;t position residual norm curve look like the others?
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="exploring-initial-state-guess-perturbations">
<h1>Exploring initial state guess perturbations<a class="headerlink" href="#exploring-initial-state-guess-perturbations" title="Permalink to this heading">#</a></h1>
<ul class="simple">
<li><p>Subconcept: Uniform sampling the surface of a <span class="math notranslate nohighlight">\(d\)</span>-sphere. <a class="reference external" href="https://extremelearning.com.au/how-to-generate-uniformly-random-points-on-n-spheres-and-n-balls/">Article (see muller method)</a></p>
<ul>
<li><p>TODO: Understand and writeup the reasoning for the muller method: That random normal  components form direction vectors that point to uniform positions on a sphere.</p></li>
</ul>
</li>
</ul>
<p>Take <span class="math notranslate nohighlight">\(d\)</span> draws from <span class="math notranslate nohighlight">\(\mathcal{N}(0,1)\)</span>.</p>
<p>Form a <span class="math notranslate nohighlight">\(d\)</span>-dimensional vector <span class="math notranslate nohighlight">\(\vec{z}\)</span> from those draws.</p>
<p>Since each component is i.i.d. normal, the joint pdf <span class="math notranslate nohighlight">\(f(\vec{z})\)</span> is the product of the individual pdfs (<strong>TODO</strong> confirm this).</p>
<p>In the 2D case:</p>
<p><span class="math notranslate nohighlight">\(f(u,v) = f(\vec{z}) = \left( \frac{1}{\sqrt{2\pi}} e^{-\frac{1}{2}u^2} \right) \left( \frac{1}{\sqrt{2\pi}} e^{-\frac{1}{2}v^2} \right)\)</span></p>
<p><span class="math notranslate nohighlight">\( \frac{1}{2\pi} e^{-\frac{1}{2}(u^2 + v^2)} = \frac{1}{2\pi} e^{-\frac{1}{2}(|\vec{z}|^2)}\)</span></p>
<p>This implies the joint distribution depends only on the <em>magnitude</em> of <span class="math notranslate nohighlight">\(\vec{z}\)</span>, not the direction. Therefore the distribution is rotation invariant. i.e The distribution is uniform along the sphere of radius <span class="math notranslate nohighlight">\(|\vec{z}|\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Testing muller algorithm to generate uniform points on a (d-1)-sphere</span>

<span class="c1"># Return a point, selected at uniform random, on a (d-1)-sphere of radius r</span>
<span class="k">def</span> <span class="nf">random_point_on_dsphere</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args</span>
<span class="sd">        r: Radius of the d-sphere</span>
<span class="sd">        d: Dimension of space. e.g. d=3 creates a sphere (a 2-sphere: 2 degrees of freedom).</span>
<span class="sd">        v0: Origin of the d-sphere</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Pick a d-dimensional direction vector</span>
    <span class="c1"># Each component independently drawn from ~N(0,1)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v0</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">d</span><span class="p">)</span>

<span class="c1"># d=2: Circle (d-1 = 1 degree of freedom)</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> 
<span class="n">axes</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span>
<span class="n">num_points</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_points</span><span class="p">,</span><span class="n">d</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">):</span>
    <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_point_on_dsphere</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># d=3: Sphere (d-1 = 2 degrees of freedom)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">num_points</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># Num points</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_points</span><span class="p">,</span><span class="n">d</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">):</span>
    <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_point_on_dsphere</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/85fc7fd7d98bae875968c820a10994e0a0940618bc6f051b2ed5ebd11bb4123c.png" src="_images/85fc7fd7d98bae875968c820a10994e0a0940618bc6f051b2ed5ebd11bb4123c.png" />
<img alt="_images/9e0026534f02aec058768f2ce4792054505b244313f965fc444670ca3d32063f.png" src="_images/9e0026534f02aec058768f2ce4792054505b244313f965fc444670ca3d32063f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Config</span>
<span class="n">num_perturbations</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

<span class="c1"># For p in a set of increasing distances (in percentage of true x0&#39;s norm)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">500.00</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Random initial state guess: </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">% perturbation of true initial state norm:&#39;</span><span class="p">)</span>

    <span class="c1"># Generate random initial state vectors perturbed by p from true initial state x0</span>
    <span class="n">x0_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">true_xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">x0_norm</span> <span class="o">*</span> <span class="n">p</span>
    <span class="n">init_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_perturbations</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_perturbations</span><span class="p">):</span>
        <span class="n">init_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_point_on_dsphere</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">true_xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
    <span class="c1"># Run Kalman filter for each initial state guess</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">estimates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v_0</span> <span class="ow">in</span> <span class="n">init_points</span><span class="p">:</span>
        <span class="n">P_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span> <span class="c1"># Start with very low confidence in predictions</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">v_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">)</span>
        <span class="c1"># Calculate NEES score</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unequal lengths. len(zs)=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span><span class="si">}</span><span class="s1">. len(true_xs)=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span><span class="si">}</span><span class="s1">. len(xs)=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="kc">False</span>
        <span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span>
        <span class="n">estimates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    
    <span class="n">plot_all_residuals_2</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">estimates</span><span class="p">)</span> 
    
<span class="c1"># Scatter plot NEES as a function of initial distance</span>

<span class="c1"># TODO next: </span>
<span class="c1"># - Break the x0 perturbations out by position, velocity, and acceleration. e.g if </span>
<span class="c1">#   position is accurate but acceleration is way off, how does that perform.</span>
<span class="c1"># - Plot perturbation distance vs time to acceptable NEES</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 0% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/4052867040959390062adbfa2f4d2dac94e525699231cda065c07cfc5e75065f.png" src="_images/4052867040959390062adbfa2f4d2dac94e525699231cda065c07cfc5e75065f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 56% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/1b4bf323a13dfee813715f3a211c87553c5bbfa246d69b9efd4f40d3865154c2.png" src="_images/1b4bf323a13dfee813715f3a211c87553c5bbfa246d69b9efd4f40d3865154c2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 111% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/53f0fb747850da6af6cad6912bcc227a29c0ae8af405cedb12a8b7d8ade0ae67.png" src="_images/53f0fb747850da6af6cad6912bcc227a29c0ae8af405cedb12a8b7d8ade0ae67.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 167% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/9af8449311c5e6a12087198b06e81f49cef3b553d2159d19e2b12bfa3548a90f.png" src="_images/9af8449311c5e6a12087198b06e81f49cef3b553d2159d19e2b12bfa3548a90f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 222% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/5229da4ae515fbc6dcb168bdccfc773d627c7700a35b4527b190ed6e1bbcf2a2.png" src="_images/5229da4ae515fbc6dcb168bdccfc773d627c7700a35b4527b190ed6e1bbcf2a2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 278% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/3b58984300b5f44c18085c3af45e82f913729aa5ea5af8ad27b9f6eb5861d777.png" src="_images/3b58984300b5f44c18085c3af45e82f913729aa5ea5af8ad27b9f6eb5861d777.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 333% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/a0f2602ab3ae9f319eb2913cac44de7cd391f0d388eee5fc03f4d00f4ecfa7f3.png" src="_images/a0f2602ab3ae9f319eb2913cac44de7cd391f0d388eee5fc03f4d00f4ecfa7f3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 389% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/1be9338f80c3b2541f93f1cef7746937d8011f5e48bb103e675ec3354e11737f.png" src="_images/1be9338f80c3b2541f93f1cef7746937d8011f5e48bb103e675ec3354e11737f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 444% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/9408c71677cd915f07c72563b9301b61167bb4dd3caebc51f82e3544343dae03.png" src="_images/9408c71677cd915f07c72563b9301b61167bb4dd3caebc51f82e3544343dae03.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random initial state guess: 500% perturbation of true initial state norm:
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
</div>
</div>
<p>Notes on above:</p>
<ul class="simple">
<li><p>When graphing in log scale, they all appear to have a middle period of linear-looking decline (regardless of initial position). The initial period is more volatile, and the final period is a leveling of (convergence). None converge at zero, which makes sense.</p></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="exploring-parameter-space-for-the-multivariable-kalman-filter-example">
<h1>Exploring parameter space for the multivariable kalman filter example<a class="headerlink" href="#exploring-parameter-space-for-the-multivariable-kalman-filter-example" title="Permalink to this heading">#</a></h1>
<p>In our initial exploration, we assumed we could configure the filter’s <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(R\)</span> values perfectly (i.e. to the noise values that were used to generate the synthetic data). But what about the more realistic scenario where we don’t know the true <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(R\)</span> values?</p>
<p>Let <span class="math notranslate nohighlight">\(Q*\)</span> and <span class="math notranslate nohighlight">\(R*\)</span> be the true process and measurement noise covariance matrices, respectively.</p>
<p>Below we explore tuning the filter’s assumed <span class="math notranslate nohighlight">\(Q\)</span> and <span class="math notranslate nohighlight">\(R\)</span> covariance matrices to percentages in the range of <span class="math notranslate nohighlight">\([0, 1000]\)</span>%.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iterate through the (Q,R) parameter space </span>
<span class="c1"># In terms of percentages of the true param values</span>
<span class="n">num_iters</span> <span class="o">=</span> <span class="mi">4</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Q is process noise. R is measurement noise.&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">p_i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">6</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_iters</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">p_j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_iters</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Q * </span><span class="si">{</span><span class="n">p_i</span><span class="si">:</span><span class="s1">.01f</span><span class="si">}</span><span class="s1">.  R * </span><span class="si">{</span><span class="n">p_j</span><span class="si">:</span><span class="s1">.01f</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">Q_true</span> <span class="o">*</span> <span class="n">p_i</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R_true</span> <span class="o">*</span> <span class="n">p_j</span>

        <span class="c1"># Run Kalman filter for (Q,R) combo</span>
        <span class="n">P_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span> <span class="c1"># Start with very low confidence in predictions</span>
        <span class="n">v_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># Start with an ok initial state</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">v_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">)</span>
        
        <span class="c1"># Plot track, measurements, and estimate for position</span>
        <span class="c1"># plt.rcParams[&quot;figure.figsize&quot;] = (10,5)</span>
        <span class="c1"># plt.plot(true_xs[:,0], true_xs[:,3], label=r&#39;$\vec{x}$&#39;,  marker=&#39;o&#39;, markersize=2)</span>
        <span class="c1"># plt.plot(xs[:,0], xs[:,3], label=r&#39;$\hat{x}$&#39;,  marker=&#39;o&#39;, markersize=2)</span>
        <span class="c1"># plt.plot(zs[:,0], zs[:,1], label=r&#39;$\vec{z}$&#39;, marker=&#39;o&#39;, linestyle=&#39;none&#39;, markersize=2)</span>
        <span class="c1"># plt.title(&#39;Kalman position estimate&#39;)</span>
        <span class="c1"># plt.xlabel(&#39;x position&#39;)</span>
        <span class="c1"># plt.ylabel(&#39;y position&#39;)</span>
        <span class="c1"># plt.legend()</span>
        <span class="c1"># plt.show()</span>
        <span class="n">xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span>
        <span class="n">Ps_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_covar_series</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>
        <span class="n">plot_estimate_covar_accuracy</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> 
                             <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x position&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;y position&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

        <span class="n">plot_all_residuals_2</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">estimates</span><span class="p">)</span> 
        
        <span class="c1"># TODO average NEES score</span>
        <span class="c1"># TODO percentage of estimates within 3-sigma of true</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q is process noise. R is measurement noise.
Q * 0.0.  R * 0.1.
</pre></div>
</div>
<img alt="_images/8b0298b1f542a4b33c24c78fc8d4463c08bb71b92b0403f2d88400603f0f6bbb.png" src="_images/8b0298b1f542a4b33c24c78fc8d4463c08bb71b92b0403f2d88400603f0f6bbb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 26.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 0.0.  R * 1.7.
</pre></div>
</div>
<img alt="_images/472b70c4246bdfc59c4b2088766ade3527e5065192b69f7794d30e6730833be5.png" src="_images/472b70c4246bdfc59c4b2088766ade3527e5065192b69f7794d30e6730833be5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 0.0.  R * 3.4.
</pre></div>
</div>
<img alt="_images/3e82bef8ff36191bf426604809c89588abe18ea98cc1ebf52ff766f75f23f1cc.png" src="_images/3e82bef8ff36191bf426604809c89588abe18ea98cc1ebf52ff766f75f23f1cc.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 0.0.  R * 5.0.
</pre></div>
</div>
<img alt="_images/d47b7c3e3ec81eaf7a273a5b7e4e736e360f7c1bfbb49be869d005b5f0b5c9f7.png" src="_images/d47b7c3e3ec81eaf7a273a5b7e4e736e360f7c1bfbb49be869d005b5f0b5c9f7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 1.7.  R * 0.1.
</pre></div>
</div>
<img alt="_images/0093697bdd998ad56b8f0956435e1765a3ce698bfcb7fa5e09eb6f6f79fb798c.png" src="_images/0093697bdd998ad56b8f0956435e1765a3ce698bfcb7fa5e09eb6f6f79fb798c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 36.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 1.7.  R * 1.7.
</pre></div>
</div>
<img alt="_images/04ef5ed698566871937bb307e86e749398d439e72c86a8ced10aa66363bc9668.png" src="_images/04ef5ed698566871937bb307e86e749398d439e72c86a8ced10aa66363bc9668.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 1.7.  R * 3.4.
</pre></div>
</div>
<img alt="_images/079a4f0fb4a0d52355a9b0c742140964b7b5fbebc90415ab64529ff8f803010a.png" src="_images/079a4f0fb4a0d52355a9b0c742140964b7b5fbebc90415ab64529ff8f803010a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 1.7.  R * 5.0.
</pre></div>
</div>
<img alt="_images/65f2fae97443b101300d00bde8412e2f0c02077026ff3c2bd6255590b52827dc.png" src="_images/65f2fae97443b101300d00bde8412e2f0c02077026ff3c2bd6255590b52827dc.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 3.3.  R * 0.1.
</pre></div>
</div>
<img alt="_images/6458c9b3a3773280279056d8713e27d6c46b2ac4228a551d419d5e4c2939a0e7.png" src="_images/6458c9b3a3773280279056d8713e27d6c46b2ac4228a551d419d5e4c2939a0e7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 38.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 3.3.  R * 1.7.
</pre></div>
</div>
<img alt="_images/24987088a5e1cb8ee5f9079ea32b4cb4ad586c15c876764c02726384af5f777b.png" src="_images/24987088a5e1cb8ee5f9079ea32b4cb4ad586c15c876764c02726384af5f777b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 3.3.  R * 3.4.
</pre></div>
</div>
<img alt="_images/3e5d2dda066013a2f72a76e429fd22c633a47c7f868e1be3d6f2dfd2740dfd27.png" src="_images/3e5d2dda066013a2f72a76e429fd22c633a47c7f868e1be3d6f2dfd2740dfd27.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 3.3.  R * 5.0.
</pre></div>
</div>
<img alt="_images/1f353bcce66cb70b050d3d2f60b68bc39f46136a83baa85721e272a58fd48299.png" src="_images/1f353bcce66cb70b050d3d2f60b68bc39f46136a83baa85721e272a58fd48299.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 5.0.  R * 0.1.
</pre></div>
</div>
<img alt="_images/9a0af069de3ff66bf745a84a47d376d8e373190e3807fd13392133089b588358.png" src="_images/9a0af069de3ff66bf745a84a47d376d8e373190e3807fd13392133089b588358.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 40.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 5.0.  R * 1.7.
</pre></div>
</div>
<img alt="_images/0a002a67f68962cd8dc9e21dd5cb8b37260d581f074b67928e5f0e5ac75fc051.png" src="_images/0a002a67f68962cd8dc9e21dd5cb8b37260d581f074b67928e5f0e5ac75fc051.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 5.0.  R * 3.4.
</pre></div>
</div>
<img alt="_images/7f7c3a376b5ea4b597097c38a483184171821c2fc022e3f583f3bf99156d7904.png" src="_images/7f7c3a376b5ea4b597097c38a483184171821c2fc022e3f583f3bf99156d7904.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q * 5.0.  R * 5.0.
</pre></div>
</div>
<img alt="_images/3dd3f96b4d92396bcf0b48a8664f26bb953adc75413648bb9511038c5ba5691d.png" src="_images/3dd3f96b4d92396bcf0b48a8664f26bb953adc75413648bb9511038c5ba5691d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percent of estimate covar ellipse containing true state: 100.00%
</pre></div>
</div>
<img alt="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" src="_images/22cea037a23bab737c247d8984c04021723d07b960babb9b2ed0b113a2bed079.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Attempt 2 at exploring param space</span>

<span class="c1"># Run the kalman filter and compute the position estimate covar accuracy score </span>
<span class="c1"># for the given Q_scale and R_scale factor</span>
<span class="k">def</span> <span class="nf">covar_accuracy_score</span><span class="p">(</span><span class="n">Q_scale</span><span class="p">,</span> <span class="n">R_scale</span><span class="p">):</span>
    <span class="c1">#print(f&#39;Q_scale:{Q_scale:.04f}. R_scale:{R_scale:.04f}.&#39;)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q_true</span> <span class="o">*</span> <span class="n">Q_scale</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R_true</span> <span class="o">*</span> <span class="n">R_scale</span>

    <span class="c1"># Run Kalman filter for (Q,R) combo</span>
    <span class="n">P_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span> <span class="c1"># Start with very low confidence in predictions</span>
    <span class="n">v_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># Start with an ok initial state</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="n">kalman_6d</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">v_0</span><span class="p">,</span> <span class="n">P_0</span><span class="p">)</span>

    <span class="n">xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_state_series</span><span class="p">(</span><span class="n">true_xs</span><span class="p">)</span>
    <span class="n">Ps_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">separate_covar_series</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
    
    <span class="n">accurate_ellipses</span> <span class="o">=</span> <span class="n">within_confidence_ellipse</span><span class="p">(</span><span class="n">true_xs_pos</span><span class="p">,</span> <span class="n">xs_pos</span><span class="p">,</span> <span class="n">Ps_pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">accurate_ellipses</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">accurate_ellipses</span><span class="p">)</span>

<span class="c1"># Iterate through the (Q,R) parameter space </span>
<span class="c1"># In terms of percentages of the true param values</span>
<span class="n">num_iters</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># The Q and R matrices are simple, they can be represented by their top left corner</span>
<span class="c1"># i.e. the variance of the x position</span>
<span class="n">Q_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">6</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span>
<span class="n">R_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span>

<span class="c1"># Meshgrid it and calculate surface of accuracy scores</span>
<span class="n">QQ_scales</span><span class="p">,</span> <span class="n">RR_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">Q_scales</span><span class="p">,</span> <span class="n">R_scales</span><span class="p">)</span>
<span class="n">est_ellipse_accuracy_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">covar_accuracy_score</span><span class="p">)(</span><span class="n">QQ_scales</span><span class="p">,</span> <span class="n">RR_scales</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">QQ_scales</span><span class="p">,</span> <span class="n">RR_scales</span><span class="p">,</span> <span class="n">est_ellipse_accuracy_scores</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Q Scale&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R Scale&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> 
<span class="c1">#ax = fig.add_subplot(111, projection=&#39;3d&#39;)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">QQ_scales</span><span class="p">,</span> <span class="n">RR_scales</span><span class="p">,</span> <span class="n">est_ellipse_accuracy_scores</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Q Scale&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R Scale&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
<span class="c1"># TODO do same contour plot for average NEES score</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/91ea9042b48ea3630023334e1d0a1fe789943ae56e049431a5f65e681c1c9789.png" src="_images/91ea9042b48ea3630023334e1d0a1fe789943ae56e049431a5f65e681c1c9789.png" />
<img alt="_images/a571f4df3b8c3298d133e66e828ae6bdbe48ae9f610de4a1e28d0a863df50f24.png" src="_images/a571f4df3b8c3298d133e66e828ae6bdbe48ae9f610de4a1e28d0a863df50f24.png" />
</div>
</div>
<p><strong>TODO</strong> Things to explore and illustrate:</p>
<ul class="simple">
<li><p>Measuring accuracy of the filter.</p>
<ul>
<li><p>Use the NEES to confirm the <em>consistency</em> of the kalman estimate. Instructions <a class="reference external" href="https://kalman-filter.com/normalized-estimation-error-squared/">here</a>.</p></li>
</ul>
</li>
<li><p>Hidden Variables: i.e. velocity and acceleration in the above model where I only have position sensor.</p></li>
<li><p><strong>Exploring the relationship between position and velocity covariance (as in Labbe chapter 6 section on “Prediction Equations”)</strong></p></li>
<li><p>Forecasting: Use the trained kalman filter to predict into the future</p></li>
<li><p>Find a better data set on which to demonstrate the filter’s usefulness</p></li>
<li><p>Tuning the filter:</p>
<ul>
<li><p>What if we’re wrong about setting our process and noise uncertainties?</p></li>
<li><p>Sensitivity to initial guess.</p></li>
<li><p>For each question, do many filter runs across all parameter states and evaluate the performance:</p>
<ul>
<li><p>Accuracy rating</p></li>
<li><p>Amount of steps before ‘convergence’</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>TODO</strong> Things to check or fix</p>
<ul class="simple">
<li><p>Confirm your covariance ellipse scale factor is correct. <a class="reference external" href="https://www.xarg.org/2018/04/how-to-plot-a-covariance-error-ellipse/">Looks different than some descriptions - not converting to chi-square s scale factor</a>. OR actually it may be the Mahalanobis distance described <a class="reference external" href="https://cookierobotics.com/007/">here</a>. Check if its right or not.</p></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="bibliography">
<h1>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this heading">#</a></h1>
<div class="docutils container" id="id6">
<div class="citation" id="id10" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">nas</a><span class="fn-bracket">]</span></span>
<p>Global land-ocean temperature index. <a class="reference external" href="https://data.giss.nasa.gov/gistemp/graphs/graph_data/Global_Mean_Estimates_based_on_Land_and_Ocean_Data/graph.txt">https://data.giss.nasa.gov/gistemp/graphs/graph_data/Global_Mean_Estimates_based_on_Land_and_Ocean_Data/graph.txt</a>. Accessed: 2023-08-10.</p>
</div>
<div class="citation" id="id9" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">Lab</a><span class="fn-bracket">]</span></span>
<p>Roger Labbe. Kalman and bayesian filters in python. <a class="github reference external" href="https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python">rlabbe/Kalman-and-Bayesian-Filters-in-Python</a>. Accessed: 2023-08-10.</p>
</div>
<div class="citation" id="id8" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>You11<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id2">2</a>,<a role="doc-backlink" href="#id4">3</a>)</span>
<p>Peter C Young. <em>Recursive estimation and time-series analysis: An introduction for the student and practitioner</em>. Springer Science &amp; Business Media, 2011.</p>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "jb"
        },
        kernelOptions: {
            name: "jb",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'jb'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Kalman Filters</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#high-level-concepts">High Level Concepts</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-bayesian-intuition-underlying-the-kalman-filter">The Bayesian Intuition underlying the Kalman Filter</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-1d-kalman-filter">Implementing the 1D Kalman Filter</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demonstration-on-temperature-data">Demonstration on temperature data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-linear-kalman-filter-applied-to-non-linear-data">A linear kalman filter applied to non-linear data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#code">CODE</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#global-temp-anomaly-data">Global Temp Anomaly Data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#bayesian-style-implementation">Bayesian Style Implementation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#rewriting-in-standard-notation">Rewriting in Standard notation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-how-the-kalman-filter-behaves-with-data-gaps">Exploring how the kalman filter behaves with data gaps</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-parameter-space-of-q-x-r">Exploring the parameter space of <span class="math notranslate nohighlight">\(Q\)</span> x <span class="math notranslate nohighlight">\(R\)</span></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#d-kalman-for-process-with-constant-acceleration">2D Kalman for Process With Constant Acceleration</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#multidimensional-linear-kalman-filter">Multidimensional linear kalman filter</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synthesizing-measurements">Synthesizing measurements</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#do-the-true-positions-vec-x-k-fall-within-the-hat-x-k-estimates-3-sigma-confidence-ellipses">Do the true positions <span class="math notranslate nohighlight">\(\vec{x}(k)\)</span> fall within the <span class="math notranslate nohighlight">\(\hat{x}(k)\)</span> estimates’ <span class="math notranslate nohighlight">\(3\sigma\)</span> confidence ellipses?</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-covariance-of-position-with-velocity">Exploring covariance of position with velocity</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#quantifying-the-accuracy-of-the-kalman-filter-s-predictions">Quantifying the Accuracy of the Kalman Filter’s Predictions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nees">NEES</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-residuals">Exploring Residuals</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-initial-state-guess-perturbations">Exploring initial state guess perturbations</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-parameter-space-for-the-multivariable-kalman-filter-example">Exploring parameter space for the multivariable kalman filter example</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#bibliography">Bibliography</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By David Ouyang Moench
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>